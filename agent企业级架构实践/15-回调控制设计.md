15-å›è°ƒæ§åˆ¶è®¾è®¡
-------------------------------------

### ã€å›è°ƒæ§åˆ¶æœºåˆ¶ã€‘Callbackè®¾è®¡è¯¦è§£ï¼šè¡Œä¸ºé“¾ä¸­æ–­å¤„ç†ä¸å®¡è®¡è·¯å¾„æ„å»º

> æ™ºèƒ½ä½“å›è°ƒæœºåˆ¶ã€Agent Callback æ¨¡å—ã€è¡Œä¸ºé“¾ç»“æœå¤„ç†ã€æ™ºèƒ½ä½“è¡Œä¸ºä¸­æ–­æ¢å¤ã€callback fallback ç­–ç•¥ã€trace ç»“æœå†™å…¥ã€memory å†™å…¥ç»“æ„ã€è¡Œä¸ºå®¡è®¡æ—¥å¿—ã€Agent ä»»åŠ¡å›è°ƒä¸­å°ã€callback æƒé™éš”ç¦»ã€[å¯è§†åŒ–](https://so.csdn.net/so/search?q=%E5%8F%AF%E8%A7%86%E5%8C%96&spm=1001.2101.3001.7020) trace å†™å…¥ã€è¡Œä¸ºé“¾é—­ç¯æ§åˆ¶ã€runtime callback hookã€å›è°ƒè§¦å‘å™¨è®¾è®¡ã€Agent çŠ¶æ€å†™å…¥æœºåˆ¶ã€å›è°ƒç»“æ„å°è£…ã€å¼‚å¸¸é“¾ç»­æ¥ã€Agentå®¡è®¡åˆè§„ç»“æ„

* * *

#### æ‘˜è¦

åœ¨ä¼ ç»Ÿç³»ç»Ÿä¸­ï¼ŒCallback å¾€å¾€è¢«å½“ä½œ"æ‰§è¡Œç»“æŸåçš„åå¤„ç†é€»è¾‘"ï¼›ä½†åœ¨æ™ºèƒ½ä½“ç³»ç»Ÿä¸­ï¼Œå®ƒæ˜¯è¡Œä¸ºé“¾çš„å…³é”®èŠ‚ç‚¹ï¼Œè´Ÿè´£å°†**å·¥å…·æ‰§è¡Œç»“æœå†™å…¥ memoryã€è®°å½•è¡Œä¸ºæ—¥å¿— traceã€è§¦å‘ä¸‹ä¸€è½®è¡Œä¸ºé“¾è·³è½¬ã€ç”šè‡³æ§åˆ¶ç³»ç»Ÿä¸­æ–­ä¸æ¢å¤é€»è¾‘**ã€‚

æœ¬ç¯‡åšå®¢å°†å…¨é¢è§£æ Callback åœ¨ä½ ç³»ç»Ÿä¸­çš„è§’è‰²ä¸ç»“æ„ï¼ŒåŒ…æ‹¬ï¼š

*   å¦‚ä½•è®¾è®¡æ ‡å‡†åŒ– CallbackHandlerï¼Œå®ç° memory Ã— trace Ã— çŠ¶æ€é“¾å†™å…¥é—­ç¯
*   å¦‚ä½•å¤„ç†å¼‚å¸¸ä¸­æ–­ä»»åŠ¡çš„å›è°ƒæ¢å¤ä¸ fallback
*   Callback ä¸­å¦‚ä½•å†³å®šå†™å…¥/è·³è¿‡/æ›¿ä»£/ç»ˆæ­¢ç­‰è¡Œä¸ºç­–ç•¥
*   å¤š Agent ååŒä»»åŠ¡ä¸‹çš„å›è°ƒæƒé™ç®¡ç†ä¸è¡Œä¸ºå½’å±æ§åˆ¶
*   å¦‚ä½•é€šè¿‡ trace + callback æ„å»ºè¡Œä¸ºå®¡è®¡è·¯å¾„ä¸å¯è§†åŒ–æ‰§è¡Œå›¾

æœ€ç»ˆï¼Œæˆ‘ä»¬å°†ç»™å‡ºä¸€ä¸ªæ”¯æŒ[é—­ç¯æ§åˆ¶](https://so.csdn.net/so/search?q=%E9%97%AD%E7%8E%AF%E6%8E%A7%E5%88%B6&spm=1001.2101.3001.7020)ã€è¡Œä¸ºç­–ç•¥ã€çŠ¶æ€å›å†™ä¸å®¡è®¡åˆè§„çš„**Callback æ‰§è¡Œä¸­å°è®¾è®¡èŒƒå¼**ã€‚

* * *

#### ç›®å½•

* * *

##### ç¬¬ä¸€ç« ï¼šæ™ºèƒ½ä½“ç³»ç»Ÿä¸­ Callback çš„çœŸæ­£èŒè´£ â€”â€” è¡Œä¸ºé“¾ç»ˆç‚¹ vs ä¸‹ä¸€è½®èµ·ç‚¹

*   å›è°ƒä¸æ˜¯å‡½æ•°ç»“å°¾ï¼Œè€Œæ˜¯çŠ¶æ€æ§åˆ¶é“¾çš„ä¸€ç¯
*   Callback ä¸ memory / trace çš„è”åŠ¨é€»è¾‘ç»“æ„
*   ä¸ºä»€ä¹ˆ Callback æ˜¯ Agent ç³»ç»Ÿ"é—­ç¯èƒ½åŠ›"çš„å…³é”®é”šç‚¹

* * *

##### ç¬¬äºŒç« ï¼šCallbackHandler æ¨¡å—ç»“æ„è®¾è®¡ä¸è¡Œä¸ºå†³ç­–æœºåˆ¶

*   å›è°ƒç»“æ„æ ‡å‡†æ¥å£è®¾è®¡ï¼ˆhandle / fallback / auditï¼‰
*   å·¥å…·æ‰§è¡Œç»“æœå°è£…ç»“æ„å»ºè®®ï¼ˆToolResultï¼‰
*   trace æ³¨å…¥ç‚¹åˆ†å¸ƒä¸äº‹ä»¶è®°å½•è§„èŒƒ
*   å›è°ƒè¡Œä¸ºç­–ç•¥å†³ç­–æ¨¡å—è®¾è®¡å»ºè®®ï¼ˆCallbackPolicyï¼‰

* * *

##### ç¬¬ä¸‰ç« ï¼šå¼‚å¸¸é“¾å›è°ƒä¸ä¸­æ–­æ¢å¤æœºåˆ¶å®ç°è·¯å¾„

*   tool fail â†’ callback fallback â†’ behavior resume é“¾ç»“æ„
*   callback å¤±è´¥é“¾é‡è¯•æœºåˆ¶ä¸æœ€å¤§å›è°ƒçª—å£è®¾è®¡
*   runtime Ã— executor Ã— callback çš„å¼‚å¸¸æµè½¬æ§åˆ¶ç»“æ„
*   trace å†™å…¥ä¸ memory æ¸…ç†çš„å¼‚å¸¸é“¾è”åŠ¨æœºåˆ¶

* * *

##### ç¬¬å››ç« ï¼šå¤š Agent ååŒä¸‹çš„å›è°ƒæƒé™ä¸å½’å±åˆ¤æ–­æœºåˆ¶

*   from_agent ä¸ to_agent åˆ†ç¦»ä¸‹ callback æƒé™å½’å±åˆ¤å®š
*   è°ƒç”¨é“¾å½’å±æ ‡è®°ä¸ trace ä¸»ä½“ç»“æ„è®¾å®šå»ºè®®
*   åˆ†å¸ƒå¼å›è°ƒè·¯ç”±ç»“æ„ï¼ˆæ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»ï¼‰
*   é˜²æ­¢ callback è¶Šæƒ / çŠ¶æ€è¯¯å†™çš„å®‰å…¨éš”ç¦»è®¾è®¡

* * *

##### ç¬¬äº”ç« ï¼šå›è°ƒä¸­å°èƒ½åŠ›è®¾è®¡ä¸è¡Œä¸ºå®¡è®¡è·¯å¾„ç”Ÿæˆå»ºè®®

*   callback hook Ã— trace event Ã— memory_writer ä¸‰è”åŠ¨ç»“æ„è®¾è®¡
*   å›è°ƒä¸­å°å¦‚ä½•å¯¹æ¥è¡Œä¸ºé“¾ç›‘æ§ç³»ç»Ÿ / å®‰å…¨å®¡è®¡ç³»ç»Ÿ
*   äº‹ä»¶ replayã€callback diffã€çŠ¶æ€å›¾æ„å»ºä¸å¯è§†åŒ–å»ºè®®
*   æ„å»º"ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ â†’ è¡Œä¸ºé“¾æ‰§è¡Œè·¯å¾„ â†’ å›è°ƒçŠ¶æ€"ä¸‰å±‚æ˜ å°„ç»“æ„

* * *

### ç¬¬ä¸€ç« ï¼šæ™ºèƒ½ä½“ç³»ç»Ÿä¸­ Callback çš„çœŸæ­£èŒè´£ â€”â€” è¡Œä¸ºé“¾ç»ˆç‚¹ vs ä¸‹ä¸€è½®èµ·ç‚¹

* * *

#### 1.1 åœ¨ä¼ ç»Ÿå·¥ç¨‹ä¸­ï¼ŒCallback é€šå¸¸åªæ‰¿æ‹…"é€šçŸ¥"ä½œç”¨

æ¯”å¦‚ï¼š

    def callback(result):
        print("Task finished:", result)
    

> âœ… è¿™æ˜¯æµç¨‹ä¸Šçš„"æ”¶å°¾"ï¼Œä¸æ˜¯ç»“æ„ä¸Šçš„"é—­ç¯"  
> âŒ ä¹Ÿä¸æ‰¿æ‹…çŠ¶æ€å†™å…¥ã€è¡Œä¸ºè·¯å¾„è·Ÿè¸ªã€å†³ç­–è·³è½¬ç­‰æ§åˆ¶èŒè´£

è¿™ç§è®¾è®¡åœ¨é™æ€å‡½æ•°å¼ç³»ç»Ÿä¸­æ˜¯å¤Ÿç”¨çš„ï¼Œä½†åœ¨**æ™ºèƒ½ä½“ç³»ç»Ÿä¸­å®Œå…¨ä¸é€‚ç”¨**ã€‚

* * *

#### 1.2 åœ¨ä½ ç³»ç»Ÿä¸­ï¼ŒCallback æ˜¯è¡Œä¸ºé“¾çš„"ä¸‰é‡é”šç‚¹"

é”šç‚¹ç±»å‹

èŒè´£

**çŠ¶æ€é”šç‚¹**

å°†å·¥å…·æ‰§è¡Œç»“æœå†™å…¥ memoryï¼Œä¾›ä¸‹ä¸€è½® Reasoner æ„é€ ä¸Šä¸‹æ–‡

**å®¡è®¡é”šç‚¹**

å°† callback è¡Œä¸ºå†™å…¥ traceï¼ˆæ ‡æ³¨ç»“æœã€å»¶è¿Ÿã€æ¥æºã€æˆåŠŸä¸å¦ï¼‰

**é“¾è·¯é”šç‚¹**

å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œåç»­è¡Œä¸ºï¼ˆå¦‚ç»§ç»­æ‰§è¡Œ / è·³è½¬ä¸‹ä¸€ä¸ªä»»åŠ¡ / ä¸­æ–­ï¼‰

* * *

#### 1.3 Callback æ˜¯è¡Œä¸ºé“¾çš„é—­ç¯æ§åˆ¶å™¨ï¼Œä¸æ˜¯é€»è¾‘å°¾éƒ¨

åœ¨ä½ çš„ç³»ç»Ÿæ‰§è¡Œé“¾ä¸­ï¼ŒCallback å¹¶ä¸æ˜¯æ‰§è¡Œé“¾çš„"å°½å¤´"ï¼Œè€Œæ˜¯ä¸€ä¸ªå…³é”®çš„**é“¾è·¯æ§åˆ¶è½¬å‘å™¨**ï¼š

    flowchart TD
        A[ToolRouter æ‰§è¡Œå·¥å…·] --> B[CallbackHandler.handle()]
        B --> C[MemoryEngine.write()]
        B --> D[TraceWriter.record()]
        B --> E[æ˜¯å¦è§¦å‘ä¸‹ä¸€è½® Executor.run()]
    

ç”±å®ƒå†³å®šï¼š

*   å·¥å…·è¿”å›ç»“æœæ˜¯å¦è¢«é‡‡çº³ï¼Ÿï¼ˆå¯ä¿¡ / ä¸å¯ä¿¡ / è¢«æ›¿æ¢ï¼‰
*   æ˜¯å¦å†™å…¥ memoryï¼ˆæ˜¯å¦æ±¡æŸ“æ¨ç†ä¸Šä¸‹æ–‡ï¼‰
*   æ˜¯å¦å†™å…¥ traceï¼ˆæ˜¯å¦å‚ä¸å®¡è®¡å›æ”¾ï¼‰
*   æ˜¯å¦è§¦å‘ä¸‹ä¸€è½® run_onceï¼ˆå¤šé˜¶æ®µè¡Œä¸ºé“¾ï¼‰
*   æ˜¯å¦ fallback åˆ°å…¶ä»–å·¥å…·ï¼ˆå¼‚å¸¸é“¾æ¢å¤ï¼‰

* * *

#### 1.4 ä¸ºä»€ä¹ˆè¯´ Callback æ˜¯"ç³»ç»Ÿè¡Œä¸ºé—­ç¯"çš„å”¯ä¸€å‡ºå…¥å£ï¼Ÿ

Reasoner è´Ÿè´£æå‡º actionï¼ŒToolRouter æ‰§è¡Œ actionï¼Œä½†ï¼š

> **çœŸæ­£è®©ä¸€æ¬¡è¡Œä¸º"è¢«è®°å½•ä¸‹æ¥""äº§ç”Ÿå½±å“""è¢«åç»­è¡Œä¸ºä½¿ç”¨"çš„ï¼Œæ˜¯ Callbackã€‚**

ç»“æ„è§’è‰²

èƒ½åŠ›ç‚¹

æ˜¯å¦å†™ memory

æ˜¯å¦å†™ trace

æ˜¯å¦å¯å½±å“ä¸‹ä¸€è½®

Reasoner

å†³ç­–èµ·ç‚¹

å¦

æ˜¯ï¼ˆREASONER_ACTIONï¼‰

æ˜¯ï¼ˆæ§åˆ¶è¡Œä¸ºè·¯å¾„ï¼‰

ToolRouter

å·¥å…·æ‰§è¡Œå™¨

å¦

æ˜¯ï¼ˆTOOL_EXECï¼‰

å¦

**Callback**

çŠ¶æ€æ³¨å…¥ + trace ç»ˆç‚¹

âœ… æ˜¯

âœ… æ˜¯ï¼ˆCALLBACK_RESULTï¼‰

âœ… æ˜¯ï¼ˆè§¦å‘ä¸‹ä¸€è½® runï¼‰

è¿™æ„å‘³ç€ï¼š

> Callback æ˜¯è¡Œä¸ºé“¾ä¸­å”¯ä¸€å¯æ§åˆ¶"å†™å…¥ç³»ç»ŸçŠ¶æ€ + ä¿®æ”¹åç»­è¡Œä¸º"çš„èŠ‚ç‚¹ã€‚

* * *

#### 1.5 å¦‚æœä½ å¿½ç•¥ Callback çš„ç­–ç•¥ç»“æ„ï¼Œä½ å°†å¤±å»ï¼š

èƒ½åŠ›

ç¼ºå¤±åæœ

çŠ¶æ€é“¾å¯æ§æ€§

å·¥å…·æ‰§è¡Œç»“æœå¯èƒ½æœªå…¥ memoryï¼Œä¸‹ä¸€è½®æ¨ç†æ— æ³•è·å¾—ä¸Šä¸‹æ–‡

trace å¯è§†åŒ–é—­ç¯

æ‰§è¡Œæ˜¯å¦æˆåŠŸï¼Ÿè€—æ—¶å¤šä¹…ï¼Ÿå¤±è´¥åŸå› æ˜¯ä»€ä¹ˆï¼Ÿä¸€å¾‹ä¸¢å¤±

å¼‚å¸¸é“¾æ¢å¤èƒ½åŠ›

ä¸€æ—¦å·¥å…·å¤±è´¥ï¼Œæ— æ³• fallback / ä¸­æ–­ /é‡è¯•

è¡Œä¸ºé“¾ç»­æ¥èƒ½åŠ›

æ— æ³•é€šè¿‡å›è°ƒè§¦å‘å¤šé˜¶æ®µ / è·¨ Agent è¡Œä¸ºç»“æ„

è°ƒç”¨å½’å±å®¡è®¡èƒ½åŠ›

æ— æ³•æ ‡è®°è¿™æ˜¯è°è§¦å‘çš„ callbackã€è°å†™äº†è¿™ä¸ªçŠ¶æ€ã€çŠ¶æ€ç”±è°è´Ÿè´£

* * *

#### 1.6 å·¥ç¨‹å»ºè®®ï¼šCallback çš„ä½œç”¨åº”è¢«æå‡ä¸ºç»“æ„è§’è‰²ï¼Œè€Œéé€»è¾‘å‡½æ•°

é¡¹ç›®

å»ºè®®

å°† callback handler æ¥å…¥ runtime æ§åˆ¶ç»“æ„

ä¿éšœå…¶èƒ½è®¿é—® trace / memory / logger / executor

å°† callback å†™å…¥ trace çš„åŠ¨ä½œå˜ä¸ºæ˜¾å¼ç­–ç•¥èŠ‚ç‚¹

trace_writer.record("CALLBACK_RESULT", {â€¦})

callback handle() å»ºè®®æ¥å— policy å‚æ•°

ç”¨äºæ§åˆ¶å†™å…¥ / fallback / è·³è½¬ç­‰è¡Œä¸ºå†³ç­–é€»è¾‘

callback å»ºè®®æ”¯æŒç»“æ„åŒ–å¤±è´¥å›ä¼ æœºåˆ¶

å¯è¿”å›ï¼šsuccess / retry / fallback / terminal

callback å¯ä½œä¸ºå¼‚å¸¸é“¾æ–­ç‚¹ / resume å…¥å£ç‚¹

ä¾› run_once å†æ¬¡è¿›å…¥æ‰§è¡Œé“¾è·¯å¾„æ¢å¤

* * *

### ç¬¬äºŒç« ï¼šCallbackHandler æ¨¡å—ç»“æ„è®¾è®¡ä¸è¡Œä¸ºå†³ç­–æœºåˆ¶

* * *

#### 2.1 CallbackHandler æ˜¯ä¸€ä¸ª"è¡Œä¸ºç»“æœå†³ç­–å™¨"ï¼Œè€Œé"æ¶ˆæ¯å›è°ƒå‡½æ•°"

åœ¨ä½ çš„ç³»ç»Ÿä¸­ï¼ŒCallback çš„æ ¸å¿ƒèŒè´£ä¸æ˜¯ç®€å•åœ°æŠŠç»“æœæ‰“å°å‡ºæ¥ï¼Œè€Œæ˜¯ï¼š

å†³ç­–ç»´åº¦

æ§åˆ¶ç‚¹

æ˜¯å¦å†™å…¥çŠ¶æ€ï¼Ÿ

memory_engine.write()

æ˜¯å¦è®°å½• traceï¼Ÿ

trace_writer.record()

æ˜¯å¦è§¦å‘åç»­è¡Œä¸ºï¼Ÿ

executor.run_next_step()

å¤±è´¥æ—¶æ˜¯å¦ fallbackï¼Ÿ

fallback_handler.invoke()

å†™å…¥æ˜¯å¦å®‰å…¨åˆæ³•ï¼Ÿ

æƒé™å®¡è®¡æ¨¡å—åˆ¤æ–­ agent å½’å±å…³ç³»

è¿™å°±å†³å®šäº† CallbackHandler æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¸¦**æ‰§è¡Œç­–ç•¥ + çŠ¶æ€æ§åˆ¶ + å¼‚å¸¸é“¾è°ƒåº¦èƒ½åŠ›**çš„æ¨¡å—ã€‚

* * *

#### 2.2 æ ‡å‡†ç»“æ„ï¼šCallbackHandler æ¨¡å—å°è£…

å»ºè®®ç»“æ„å¦‚ä¸‹ï¼š

    class CallbackHandler:
        def __init__(self, memory_engine, trace_writer, fallback_handler, policy_resolver):
            self.memory = memory_engine
            self.trace = trace_writer
            self.fallback = fallback_handler
            self.policy_resolver = policy_resolver
    
        def handle(self, result: "ToolResult", context: dict):
            policy = self.policy_resolver.resolve(result, context)
    
            if policy.write_memory:
                self.memory.write(result.to_memory_entry())
    
            if policy.record_trace:
                self.trace.record(result.trace_id, "CALLBACK_RESULT", result.to_trace_event())
    
            if policy.fallback_required:
                return self.fallback.invoke(result)
    
            if policy.trigger_next:
                return self._trigger_next_action(result, context)
    
            return result
    

* * *

#### 2.3 ToolResultï¼šå·¥å…·è°ƒç”¨ç»“æœçš„ç»“æ„åŒ–æŠ½è±¡æ¨¡å‹

ä½ çš„ç³»ç»Ÿå»ºè®®å°†å·¥å…·è¿”å›ç»“æœå°è£…ä¸ºç»“æ„ä½“ï¼Œè€Œéè£¸å­—å…¸ï¼Œä»¥æ”¯æŒå¤šç»´è¡Œä¸ºç­–ç•¥æ¨ç†ï¼š

    class ToolResult:
        def __init__(self, output: str, success: bool, tool: str, trace_id: str, timestamp: datetime, metadata: dict):
            self.output = output
            self.success = success
            self.tool = tool
            self.trace_id = trace_id
            self.metadata = metadata
    
        def to_memory_entry(self) -> MemoryEntry: ...
        def to_trace_event(self) -> dict: ...
    

> æ”¯æŒç»“æ„åŒ–åˆ¤æ–­æ˜¯å¦æˆåŠŸã€æ˜¯å¦è§¦å‘ retryã€æ˜¯å¦å¯è¿½è¸ªã€æ˜¯å¦å¯ä¿¡ç­‰é€»è¾‘ã€‚

* * *

#### 2.4 CallbackPolicyï¼šè¡Œä¸ºåå¤„ç†ç­–ç•¥çš„ç»Ÿä¸€æŠ½è±¡ç»“æ„

å»ºè®®å®šä¹‰å¦‚ä¸‹ç­–ç•¥ç»“æ„ä½“ï¼š

    class CallbackPolicy:
        def __init__(self, write_memory: bool, record_trace: bool, fallback_required: bool, trigger_next: bool):
            ...
    

å¹¶æ”¯æŒç­–ç•¥è§£ææ¨¡å—æ³¨å…¥ï¼š

    class PolicyResolver:
        def resolve(result: ToolResult, context: dict) -> CallbackPolicy:
            ...
    

##### ç¤ºä¾‹è§„åˆ™ï¼š

æ¡ä»¶

ç­–ç•¥å†³ç­–

result.success = False

fallback_required = True

result.tool = "search" and confidence < 0.5

write_memory = False

metadata.intent = "multi_step"

trigger_next = True

* * *

#### 2.5 trace æ³¨å…¥ç»“æ„å»ºè®®

æ¯æ¬¡å›è°ƒç»“æœåº”å†™å…¥ç»“æ„åŒ– trace_eventï¼š

    self.trace.record(trace_id, "CALLBACK_RESULT", {
        "tool": result.tool,
        "success": result.success,
        "timestamp": result.timestamp,
        "metadata": result.metadata
    })
    

å¹¶å¯èšåˆç”Ÿæˆè¡Œä¸ºé“¾å¯è§†è·¯å¾„ï¼š

    trace_id: abc-123
    â†’ REASONER_ACTION
    â†’ TOOL_EXEC
    â†’ CALLBACK_RESULT
    â†’ (optional) EXEC_NEXT
    

* * *

#### 2.6 _trigger_next_action å»ºè®®ç»“æ„ï¼ˆæ”¯æŒé“¾å¼è¡Œä¸ºï¼‰

    def _trigger_next_action(self, result, context):
        next_action = self._build_action_from_result(result)
        return executor.run_next_step(next_action)
    

æ”¯æŒ callback å†³ç­–æ˜¯å¦ç»§ç»­åç»­è¡Œä¸ºï¼ˆå¦‚å¤šé˜¶æ®µ Agentã€planner-agent ç»“æ„ï¼‰ã€‚

* * *

#### 2.7 å·¥ç¨‹å»ºè®®ï¼šå›è°ƒæ¨¡å—ç»“æ„ä¼˜åŒ–æ¸…å•

é¡¹ç›®

å»ºè®®

å°† Callback æ‹†åˆ†ä¸º handler + policy + fallback ä¸‰æ¨¡å—

å®ç°è§£è€¦ã€ç­–ç•¥æ§åˆ¶ã€ç»“æ„é‡ç”¨

ToolResult ç»“æ„å»ºè®®å¯æ‰©å±•æ”¯æŒä¿¡ä»»åº¦ã€æ‰§è¡Œè€—æ—¶ã€æ•°æ®æºæ¥æºç­‰å­—æ®µ

å¢å¼ºç­–ç•¥å†³ç­–ç²¾åº¦

CallbackPolicy æ”¯æŒæ³¨å…¥é“¾çº§è§„åˆ™ï¼ˆå¦‚ä»»åŠ¡æ„å›¾ã€é˜¶æ®µçŠ¶æ€ï¼‰

å®ç°å¤šé˜¶æ®µ Agent æ§åˆ¶é€»è¾‘

trace_writer å»ºè®®æŒ‰å›è°ƒ sourceï¼ˆfrom_agent / to_agentï¼‰è®°å½•è¡Œä¸ºå½’å±

æ”¯æŒååŒä»»åŠ¡å®¡è®¡å½’å±åˆ¤æ–­

æ‰€æœ‰å¼‚å¸¸å›è°ƒå»ºè®®ç»Ÿä¸€ fallback.invoke å°è£…

æå‡é”™è¯¯é“¾æ¢å¤ä¸€è‡´æ€§

* * *

### ç¬¬ä¸‰ç« ï¼šå¼‚å¸¸é“¾å›è°ƒä¸ä¸­æ–­æ¢å¤æœºåˆ¶å®ç°è·¯å¾„

* * *

#### 3.1 Tool æ‰§è¡Œå¤±è´¥ â‰  æ•´ä¸ªä»»åŠ¡å¤±è´¥ï¼ŒCallback æ˜¯å¼‚å¸¸é“¾çš„"å…œåº•å¤„ç†å™¨"

åœ¨ä½ ç³»ç»Ÿä¸­ï¼Œä¸€æ¬¡æ™ºèƒ½ä½“è¡Œä¸ºé“¾é€šå¸¸åŒ…å«ï¼š

    Reasoner ç”Ÿæˆ action â†’ ToolRouter æ‰§è¡Œ â†’ Callback å†™å…¥çŠ¶æ€ / å†³å®šåç»­
    

è‹¥ Tool è°ƒç”¨å¤±è´¥ï¼š

*   ä¸æ˜¯ç«‹å³æŠ¥é”™ç»“æŸ
*   è€Œæ˜¯ Callback å¯åŠ¨å¼‚å¸¸é“¾å¤„ç†é€»è¾‘ï¼š

å¤„ç†è·¯å¾„

æ§åˆ¶ç‚¹

fallback æ‰§è¡Œæ›¿ä»£å·¥å…·

fallback_handler.invoke()

é‡è¯•ç›¸åŒå·¥å…·ï¼ˆå¸¦ cooldown / æ¬¡æ•°é™åˆ¶ï¼‰

retry_manager.retry()

å†™å…¥é”™è¯¯çŠ¶æ€ trace_event

trace_writer.record(TOOL_FAIL)

å†³å®šä¸­æ–­ or ç»§ç»­ä¸‹ä¸€æ­¥

callback_policy.trigger_next = False or True

* * *

#### 3.2 fallback_handler ç»“æ„å»ºè®®ï¼šæ‰˜ç®¡å¼‚å¸¸é“¾å›è°ƒç­–ç•¥æ¨¡å—

    class FallbackHandler:
        def __init__(self, registry: dict, trace_writer):
            self.registry = registry  # æ³¨å†Œå·¥å…·åˆ«å â†’ æ›¿ä»£å·¥å…·æ˜ å°„
            self.trace = trace_writer
    
        def invoke(self, failed_result: ToolResult):
            fallback_tool = self._select_alternative(failed_result.tool)
            self.trace.record(failed_result.trace_id, "CALLBACK_FALLBACK", {
                "original_tool": failed_result.tool,
                "fallback_tool": fallback_tool
            })
            return self._execute_fallback(fallback_tool, failed_result)
    

æ”¯æŒçš„ç­–ç•¥åŒ…æ‹¬ï¼š

*   å·¥å…·çº§ fallbackï¼ˆå¦‚ LLM A â†’ LLM Bï¼‰
*   agent çº§ fallbackï¼ˆå¦‚ planner_agent è½¬è°ƒ resolver_agentï¼‰
*   ç»“æœç»“æ„çº§ fallbackï¼ˆå¦‚è¿”å›é»˜è®¤å€¼ã€ç¼“å­˜å€¼ï¼‰

* * *

#### 3.3 retry_manager æ¨¡å—ç»“æ„ï¼ˆå»ºè®®ç»“åˆ trace + metadata æ§åˆ¶ï¼‰

    class RetryManager:
        def should_retry(self, result: ToolResult) -> bool:
            if result.metadata.get("retry_count", 0) >= 3:
                return False
            return not result.success
    
        def retry(self, result: ToolResult) -> ToolResult:
            # å¢åŠ  retry_count + backoff delay
            ...
    

æ¯æ¬¡ retry å¯æ³¨å…¥ traceï¼š

    trace_writer.record(result.trace_id, "CALLBACK_RETRY", {
        "tool": result.tool,
        "attempt": result.metadata.get("retry_count", 0)
    })
    

* * *

#### 3.4 trace å†™å…¥ç»“æ„ï¼šå¦‚ä½•æ„å»º"ä¸­æ–­é“¾è·¯å¾„"

    â†’ REASONER_ACTION
    â†’ TOOL_EXEC (fail)
    â†’ CALLBACK_RESULT (failure recorded)
    â†’ CALLBACK_FALLBACK
    â†’ TOOL_EXEC (fallback success)
    â†’ CALLBACK_RESULT (success)
    

å»ºè®®è®°å½•å¤±è´¥é“¾å­—æ®µï¼š

trace_event

å­—æ®µ

`CALLBACK_RESULT`

`{"status": "failed", "reason": "...", "tool": "xyz"}`

`CALLBACK_FALLBACK`

`{"fallback_tool": "xyz2"}`

`CALLBACK_RETRY`

`{"attempt": 2}`

è¿™æ ·ä½ å¯ä»¥æ„å»ºå‡ºè¡Œä¸ºé“¾æ¢å¤æµç¨‹å›¾ï¼Œå¹¶ç”¨äºï¼šé‡æ¼”ã€ç­–ç•¥ä¼˜åŒ–ã€ç›‘æ§å‘Šè­¦ç­‰åŠŸèƒ½ã€‚

* * *

#### 3.5 Runtime Ã— Executor Ã— Callback ä¸‰è€…è”åŠ¨çš„å¼‚å¸¸é“¾æ¢å¤ç»“æ„

åœ¨ä½ ç³»ç»Ÿä¸­ï¼Œå»ºè®® Callback æ¨¡å—å…·å¤‡å¼‚å¸¸ä¸ŠæŠ¥é€šé“ï¼ŒExecutor æ•è·å¼‚å¸¸çŠ¶æ€ï¼ŒRuntime æä¾›æ¢å¤æ”¯æ’‘ï¼š

    [ToolRouter fails]
      â†“
    [CallbackHandler.handle(result)]
      â†“
    [fallback_handler.invoke() â†’ result_fallback]
      â†“
    [Runtime.write_memory(result_fallback)]
      â†“
    [Executor.run_next_step() or return result]
    

è‹¥ fallback ä¹Ÿå¤±è´¥ï¼š

      â†“
    [CallbackHandler returns terminal error]
      â†“
    [Executor stops execution]
      â†“
    [Runtime logs trace: EXEC_TERMINATED]
    

> æ•´ä¸ªè·¯å¾„è¢«å®Œæ•´è®°å½•ã€ç»“æ„é—­ç¯ã€çŠ¶æ€æ›´æ–°ã€è¡Œä¸ºé“¾å¯è§†ã€‚

* * *

#### 3.6 å·¥ç¨‹å»ºè®®ï¼šå¼‚å¸¸é“¾ç»“æ„è®¾è®¡ä¸è¡Œä¸ºé“¾å®¹é”™èƒ½åŠ›æå‡æ¸…å•

é¡¹ç›®

å»ºè®®

æ‰€æœ‰ ToolResult ç»“æ„å»ºè®®ç»Ÿä¸€ `success` / `error_reason` å­—æ®µ

ç”¨äºç­–ç•¥åˆ¤æ–­å’Œ trace è®°å½•

fallback / retry æ¨¡å—åº”å…·å¤‡ç‹¬ç«‹ trace å†™å…¥èƒ½åŠ›

è¡Œä¸ºé“¾ä¸­æ–­è·¯å¾„å¿…é¡»å¯å›æº¯

trace_writer åº”æ”¯æŒ FAIL ç±»å‹äº‹ä»¶å¿«é€ŸæŸ¥è¯¢æ¥å£

æ”¯æŒç›‘æ§ / æŠ¥è­¦æ¨¡å—æ¥å…¥

Runtime å»ºè®®æ”¯æŒ register_fallback_handler / recover_chain æ¥å£

ä½¿è°ƒåº¦é“¾å…·å¤‡ resume èƒ½åŠ›

æ‰€æœ‰ callback é”™è¯¯åº”å…·å¤‡ "terminal / retryable / replaceable" ä¸‰æ€æ ‡è®°

ç»Ÿä¸€å¼‚å¸¸ç­–ç•¥æ¥å£

* * *

### ç¬¬å››ç« ï¼šå¤š Agent ååŒä¸‹çš„å›è°ƒæƒé™ä¸å½’å±åˆ¤æ–­æœºåˆ¶

* * *

#### 4.1 å¤š Agent ååŒä»»åŠ¡ï¼šCallback ä¸å†æ˜¯"å†…éƒ¨å‡½æ•°"ï¼Œè€Œæ˜¯"è·¨ Agent æƒé™èŠ‚ç‚¹"

> åœ¨ä½ ç³»ç»Ÿä¸­ï¼Œè¡Œä¸ºé“¾å¾€å¾€ä¸æ˜¯ä¸€ä¸ª Agent ç‹¬ç«‹å®Œæˆï¼Œè€Œæ˜¯å¤šä¸ª Agent è”åˆååŒå®Œæˆï¼š

    [planner_agent] â†’ è°ƒç”¨ â†’ [search_agent] â†’ Tool æ‰§è¡Œ â†’ [Callback] â†’ å†™å…¥çŠ¶æ€
    

æ­¤æ—¶ï¼ŒCallback çš„å½’å±å‡ºç°ä¸‰ç§æƒ…å†µï¼š

æ¥æº

æ‰§è¡Œè€…

å›è°ƒæ–¹

A Agent

B Agent

A Agent

A Agent

B Agent

B Agent

User è°ƒç”¨

System Agent

å…±äº« Agent æˆ–ç§Ÿæˆ·ä¸­å°

* * *

#### 4.2 ä¸ºä»€ä¹ˆå¿…é¡»å¯¹ Callback æƒé™åšéš”ç¦»åˆ¤æ–­ï¼Ÿ

##### é£é™©ä¸€ï¼šå†™å…¥ memory çš„ Agent ä¸å…·å¤‡ä¸Šä¸‹æ–‡è®¿é—®æƒé™

*   Callback å†™å…¥çš„æ˜¯ A Agent çš„ memoryï¼Œä½†æ­¤è¡Œä¸ºç”± B Agent æ‰§è¡Œ
*   å¯èƒ½é€ æˆ memory è¢«éæˆæƒ Agent å†™å…¥ï¼ˆæ±¡æŸ“çŠ¶æ€ã€è¶Šæƒ traceï¼‰

##### é£é™©äºŒï¼štrace è¢«é”™è¯¯è®°å½•ï¼ˆå½’å±ä¸æ˜ï¼‰

*   trace_id æ¥è‡ªäº planner_agentï¼Œä½† callback æ˜¯ç”± tool_agent å†™å…¥
*   æ— æ³•å®šä½è¡Œä¸ºæ‰§è¡Œä¸»ä½“ã€å½’å› å¤±è´¥ã€è°ƒè¯•æ–­é“¾

##### é£é™©ä¸‰ï¼šcallback è¢«ä¼ªé€  / ä¸­é—´äººä»£ç†æ‰§è¡Œï¼ˆå°¤å…¶åœ¨å¤šç§Ÿæˆ·ç³»ç»Ÿä¸­ï¼‰

* * *

#### 4.3 å»ºè®®å¼•å…¥ç»“æ„å­—æ®µï¼šCallback Context Binding

    class CallbackContext:
        def __init__(self, trace_id: str, context_id: str, source_agent: str, executing_agent: str):
            self.trace_id = trace_id
            self.context_id = context_id
            self.source_agent = source_agent  # who owns this trace
            self.executing_agent = executing_agent  # who is running this callback
    

æ¯æ¬¡ callback æ‰§è¡Œæ—¶æ ¡éªŒï¼š

    if context.source_agent != context.executing_agent:
        if not has_callback_right(context.executing_agent, context.source_agent):
            raise PermissionError("Callback cross-agent not allowed")
    

* * *

#### 4.4 å»ºè®® trace_event å†™å…¥å½’å±å­—æ®µæ ‡æ³¨

æ¯æ¬¡ Callback å†™å…¥ trace æ—¶ï¼Œå»ºè®®å¸¦ä¸¤ä¸ªå­—æ®µï¼š

    {
      "trace_id": "abc-123",
      "event": "CALLBACK_RESULT",
      "agent_owner": "planner_agent",
      "executed_by": "search_agent",
      "write_scope": "memory/planner_agent"
    }
    

> è¿™æ ·ä½ åœ¨å®¡è®¡ç³»ç»Ÿä¸­å¯å¿«é€Ÿè¯†åˆ«"è¡Œä¸ºé“¾æ˜¯è°å‘èµ·""è°åœ¨å†™çŠ¶æ€""æ˜¯å¦å­˜åœ¨è·¨è¾¹ç•Œå†™å…¥"ç­‰é—®é¢˜ã€‚

* * *

#### 4.5 memory_engine å»ºè®®å¢åŠ è®¿é—®è¾¹ç•Œæ§åˆ¶æœºåˆ¶

    class MemoryEngine:
        def write(entry: MemoryEntry, agent_id: str):
            if entry.target_agent != agent_id and not has_cross_write_right(agent_id, entry.target_agent):
                raise PermissionError("Unauthorized memory write")
    

æ”¯æŒä¸¤ç§å†™å…¥æ¨¡å¼ï¼š

æ¨¡å¼

æè¿°

**Agent-owned**

åªå…è®¸ Agent å†™å…¥è‡ªå·±åä¸‹ memoryï¼ˆé»˜è®¤ï¼‰

**Tenant-shared**

å¤š Agent å¯è®¿é—®åŒç§Ÿæˆ· memory poolï¼ˆéœ€æ³¨å†Œ whitelistï¼‰

* * *

#### 4.6 å¤šç§Ÿæˆ·åœºæ™¯ä¸‹ callback æƒé™éš”ç¦»æœºåˆ¶å»ºè®®

å»ºè®®å¼•å…¥ä»¥ä¸‹æ§åˆ¶ç»“æ„ï¼š

æ§åˆ¶å±‚

å»ºè®®æœºåˆ¶

trace_id â†’ tenant_id æ˜ å°„è¡¨

é˜²æ­¢ callback å†™å…¥éæœ¬ç§Ÿæˆ·ä»»åŠ¡é“¾

callback_role æ³¨å†Œè¡¨

æ§åˆ¶å“ªäº› Agent å¯æ‰§è¡Œå“ªäº›ç±»å‹ callback

context_id éš”ç¦»å±‚

æ¯ä¸ª Agent çš„ context å•ç‹¬ç»´æŠ¤ï¼Œä¸å…è®¸å¤–éƒ¨ Agent æ³¨å…¥

callback å®¡è®¡ä¸­é—´ä»¶

æ¯æ¬¡å›è°ƒå†™å…¥éƒ½è®°å½•ã€Œwho â†’ what â†’ where â†’ whenã€å…ƒä¿¡æ¯

* * *

#### 4.7 å·¥ç¨‹å»ºè®®ï¼šcallback æƒé™ä¸å½’å±å®‰å…¨æœºåˆ¶æ¸…å•

é¡¹ç›®

å»ºè®®

callback æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­åº”å¼ºåˆ¶å¸¦å…¥ source_agent / executing_agent å­—æ®µ

ä¾›å®¡è®¡ä¸å½’å±åˆ¤æ–­ä½¿ç”¨

memory å†™å…¥åº”æ ¡éªŒ agent_id ä¸ entry.target_agent æ˜¯å¦ä¸€è‡´

å¹¶å¯ç”¨è·¨å†™æƒé™ç™½åå•æœºåˆ¶

trace_writer å†™å…¥å»ºè®®å¸¦ agent_owner / executed_by å…ƒä¿¡æ¯

æ”¯æŒå¯è§†åŒ–é“¾å½’å±é«˜äº®

å¤šç§Ÿæˆ·ç³»ç»Ÿä¸­å»ºè®®æ„å»º callback sandbox

é™å®šæ¯ä¸ª agent çš„ callback å¯è§èŒƒå›´ / å†™å…¥è¾¹ç•Œ

æ‰€æœ‰è·¨ Agent å›è°ƒå»ºè®®è®°å½• callback_permission äº‹ä»¶

æ”¯æŒé“¾å¼å®¡è®¡ä¸æƒé™è¡Œä¸ºå›æº¯

* * *

### ç¬¬äº”ç« ï¼šå›è°ƒä¸­å°èƒ½åŠ›è®¾è®¡ä¸è¡Œä¸ºå®¡è®¡è·¯å¾„ç”Ÿæˆå»ºè®®

* * *

#### 5.1 å›è°ƒä¸­å°ï¼šä¸ä»…æ˜¯ handle(result)ï¼Œè€Œæ˜¯è¡Œä¸ºåå¤„ç†æ§åˆ¶ä¸­å¿ƒ

ä½ ç³»ç»Ÿä¸­çš„ CallbackHandler å·²å…·å¤‡å¦‚ä¸‹ç»“æ„èƒ½åŠ›ï¼š

èƒ½åŠ›æ¨¡å—

åŠŸèƒ½

MemoryWriter

å†™å…¥å·¥å…·æ‰§è¡Œç»“æœï¼Œæ›´æ–°çŠ¶æ€é“¾

TraceWriter

è®°å½•è¡Œä¸ºè·¯å¾„ã€è°ƒç”¨é“¾é”šç‚¹ä¸å…ƒä¿¡æ¯

FallbackHandler

æ‰§è¡Œå¼‚å¸¸æ¢å¤ã€å·¥å…·æ›¿ä»£ã€å›è°ƒä¿®æ­£

PolicyResolver

å†³ç­–æ˜¯å¦æ‰§è¡Œã€å†™å…¥ã€ç»­æ¥ã€ç»ˆæ­¢

ExecutorBridge

å†³å®šæ˜¯å¦è§¦å‘ä¸‹ä¸€è½®è¡Œä¸ºé“¾ï¼ˆå¦‚å¤šé˜¶æ®µä»»åŠ¡ï¼‰

è¿™äº›æ¨¡å—åˆèµ·æ¥ï¼Œå°±æ„æˆäº†ä¸€ä¸ªå…·å¤‡å®Œæ•´è°ƒåº¦èƒ½åŠ›çš„ä¸­å°æ§åˆ¶å™¨ï¼š**Callback ä¸­å°ï¼ˆCallback Hubï¼‰**

* * *

#### 5.2 æ¨¡å—ç»“æ„å»ºè®®ï¼šCallbackHub æ¶æ„å°è£…

    class CallbackHub:
        def __init__(self, handler: CallbackHandler, fallback: FallbackHandler, trace_writer, runtime):
            self.handler = handler
            self.fallback = fallback
            self.trace = trace_writer
            self.runtime = runtime
    
        def process(self, result: ToolResult, context: CallbackContext):
            try:
                decision = self.handler.handle(result, context)
                self.trace.record(context.trace_id, "CALLBACK_SUCCESS", {"next": decision.trigger_next})
                if decision.trigger_next:
                    return self.runtime.executor.run_next_step(decision.next_action)
            except Exception as e:
                self.trace.record(context.trace_id, "CALLBACK_FAIL", {"reason": str(e)})
                return self.fallback.invoke(result)
    

* * *

#### 5.3 trace Ã— callback Ã— memory ä¸‰è€…è”åŠ¨æ„å»ºå®¡è®¡è·¯å¾„

å®Œæ•´å›è°ƒå®¡è®¡é“¾æ¡å»ºè®®å¦‚ä¸‹ç»“æ„ï¼š

    â†’ TOOL_EXEC
    â†’ CALLBACK_RESULT
    â†’ CALLBACK_POLICY_RESOLVED
    â†’ CALLBACK_MEMORY_WRITE
    â†’ CALLBACK_TRACE_RECORD
    â†’ CALLBACK_NEXT_ACTION (å¯é€‰)
    â†’ EXEC_NEXT (å¯é€‰)
    

æ¯ä¸€ä¸ª trace_event åŒ…å«ï¼š

*   å½“å‰è¡Œä¸ºå½’å± Agent
*   æ‰§è¡Œæ—¶é—´
*   callback ç­–ç•¥æ‘˜è¦
*   memory å†™å…¥å¿«ç…§ hash
*   fallback è§¦å‘è®°å½•ï¼ˆå¦‚å‘ç”Ÿï¼‰

* * *

#### 5.4 å›è°ƒè¡Œä¸ºå¯è§†åŒ–å»ºè®®ç»“æ„ï¼ˆè¡Œä¸ºé“¾ä¸­å°å›¾è°±ï¼‰

å¯æ„å»ºä»¥ä¸‹è§†å›¾ç³»ç»Ÿï¼š

æ¨¡å—

åŠŸèƒ½æè¿°

**Callback Chain Explorer**

å±•ç¤ºä¸€ä¸ªè¡Œä¸ºé“¾ä¸­æ‰€æœ‰ callback ç‚¹ã€æ˜¯å¦æˆåŠŸã€æ˜¯å¦ä¸­æ–­ã€æ‰§è¡Œ Agent

**Memory Write Diff Viewer**

å¯¹æ¯” callback å‰å memory çŠ¶æ€å˜æ›´ï¼ˆè¡Œä¸ºçŠ¶æ€æ„ŸçŸ¥è·¯å¾„ï¼‰

**Callback Trace Annotator**

å±•ç¤º trace_id ä¸‹ callback æ‰€å±èŠ‚ç‚¹ã€å…³è” toolã€ä¸Šä¸‹æ¸¸è¡Œä¸ºå½’å±

**Exception Replay Panel**

ä» callback å¤±è´¥ç‚¹é‡æ”¾è¡Œä¸ºé“¾ï¼Œæ”¯æŒç­–ç•¥åˆ‡æ¢ / å·¥å…·æ›¿ä»£æµ‹è¯•

**å®¡è®¡å¿«ç…§ç”Ÿæˆå™¨**

ç”Ÿæˆ callback è·¯å¾„ç»“æ„å›¾ + memory trace å¿«ç…§ + fallback è·¯å¾„æŠ¥å‘Š

* * *

#### 5.5 é¢å‘å¹³å°æ¼”åŒ–ï¼šCallbackHub åº”æ”¯æŒçš„å¢å¼ºèƒ½åŠ›

èƒ½åŠ›ç±»å‹

æ”¯æŒå»ºè®®

æ’ä»¶åŒ–æ‰©å±•

CallbackPolicy / TraceWriter / MemoryAdapter æ”¯æŒæ³¨å…¥ç»“æ„

ç­–ç•¥æŒ‚è½½

å›è°ƒç‚¹æ”¯æŒæŒ‚è½½è‡ªå®šä¹‰ç­–ç•¥ï¼ˆDSL / JSON-Rulesï¼‰

æƒé™æ§åˆ¶

é’ˆå¯¹å†™å…¥ç›®æ ‡ memory / trace_id æ˜ å°„åšæƒé™æ ¡éªŒæ¨¡å—å°è£…

å›è°ƒé“¾æ³¨å†Œå™¨

æ‰€æœ‰ callback æ”¯æŒé“¾å¼ç»„åˆã€å¹¶è¡Œè§¦å‘ã€æ¡ä»¶è°ƒç”¨ç­‰é«˜çº§é…ç½®

å¼‚æ­¥å›è°ƒæ”¯æŒ

æä¾› delay_callback / queue_callback ç­‰ä¸­é—´ä»¶é€‚é…å™¨

* * *

#### 5.6 å·¥ç¨‹å»ºè®®ï¼šæ„å»ºå…·å¤‡å®¡è®¡èƒ½åŠ›çš„ Callback ä¸­å°èƒ½åŠ›æ¸…å•

å»ºè®®é¡¹

è¯´æ˜

æ‰€æœ‰ callback å»ºè®®ç»Ÿä¸€é€šè¿‡ CallbackHub ç®¡ç†

é¿å…é€»è¾‘åˆ†æ•£ã€trace ç¼ºå¤±ã€å®¡è®¡ä¸­æ–­

trace_writer å»ºè®®æ”¯æŒ callback_view(trace_id) API

ç”¨äºé“¾å¼è¡Œä¸ºè·¯å¾„è°ƒè¯•ä¸å‰ç«¯å¯è§†åŒ–æ¥å…¥

fallback_handler å»ºè®®å…·å¤‡å¼‚å¸¸é“¾ç»Ÿè®¡èƒ½åŠ›

æ±‡æ€» fallback åŸå›  / é¢‘ç‡ / å·¥å…·åˆ†å¸ƒå›¾

memory_engine å»ºè®®æä¾› write_snapshot(versioned=true)

æ”¯æŒ diff / å›æ»šç­‰çŠ¶æ€è°ƒè¯•åŠŸèƒ½

å¯è§†åŒ–å»ºè®®ä½¿ç”¨ DAG æ¸²æŸ“ callback trace ç‚¹ä½ç»“æ„

æ”¯æŒè°ƒè¯• / å®¡è®¡ / è¡Œä¸ºé“¾å‹æµ‹å¯¹æ¯”åˆ†æ

* * *

### å°ç»“

æœ¬ç¯‡åšå®¢ç³»ç»Ÿæ‹†è§£äº†æ™ºèƒ½ä½“è¡Œä¸ºé—­ç¯ä¸­çš„æ§åˆ¶æ ¸å¿ƒï¼šCallback æ¨¡å—ï¼Œå¹¶æå‡ºå¦‚ä¸‹å…³é”®ç»“æ„èŒƒå¼ï¼š

*   **Callback æ˜¯è¡Œä¸ºé“¾çš„é—­ç¯æ§åˆ¶å™¨ï¼Œä¸æ˜¯é€»è¾‘ç»ˆç‚¹**
*   **handle + fallback + trace + memory æ„æˆå®Œæ•´è¡Œä¸ºå›å†™é“¾**
*   **CallbackPolicy æ§åˆ¶è¡Œä¸ºåå¤„ç†è·¯å¾„ï¼Œæ”¯æŒè¡Œä¸ºè·³è½¬ / çŠ¶æ€å†™å…¥ / trace å®¡è®¡**
*   **å›è°ƒæƒé™ã€è·¨ Agent å†™å…¥å½’å±ã€ç§Ÿæˆ·éš”ç¦»å¿…é¡»æ˜¾å¼æ§åˆ¶**
*   **æ„å»º CallbackHub ä¸­å°èƒ½åŠ›ï¼Œç»Ÿä¸€è¡Œä¸ºé—­ç¯ã€trace å¯è§†ã€å¼‚å¸¸æ¢å¤ã€ç­–ç•¥æ³¨å…¥ã€å®¡è®¡æ”¯æŒ**

* * *

> ä¸ªäººç®€ä»‹  
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/9175bf9a92ea44b08bdb52394892cd49.jpeg#pic_center)  
> ä½œè€…ç®€ä»‹ï¼šå…¨æ ˆç ”å‘ï¼Œå…·å¤‡ç«¯åˆ°ç«¯ç³»ç»Ÿè½åœ°èƒ½åŠ›ï¼Œä¸“æ³¨å¤§æ¨¡å‹çš„å‹ç¼©éƒ¨ç½²ã€å¤šæ¨¡æ€ç†è§£ä¸ Agent æ¶æ„è®¾è®¡ã€‚ çƒ­çˆ±"ç»“æ„"ä¸"ç§©åº"ï¼Œç›¸ä¿¡å¤æ‚ç³»ç»ŸèƒŒåæ€»æœ‰ç®€æ´å¯æ§çš„å¯èƒ½ã€‚  
> æˆ‘å«è§‚ç†µã€‚ä¸æ˜¯åœ¨æ§ç†µï¼Œå°±æ˜¯åœ¨è§‚æµ‹ç†µçš„æµåŠ¨  
> ä¸ªäººä¸»é¡µï¼š[è§‚ç†µ](https://zhxin.blog.csdn.net/)  
> ä¸ªäººé‚®ç®±ï¼šprivatexxxx@163.com  
> åº§å³é“­ï¼šæ„¿ç§‘æŠ€ä¹‹å…‰ï¼Œä¸æ­¢ç…§äº®æ™ºèƒ½ï¼Œä¹Ÿç…§äº®äººå¿ƒï¼

#### ä¸“æ å¯¼èˆª

> è§‚ç†µç³»åˆ—ä¸“æ å¯¼èˆªï¼š  
> [AIå‰æ²¿æ¢ç´¢](https://blog.csdn.net/sinat_28461591/category_12921322.html)ï¼šä»å¤§æ¨¡å‹è¿›åŒ–ã€å¤šæ¨¡æ€äº¤äº’ã€AIGCå†…å®¹ç”Ÿæˆï¼Œåˆ°AIåœ¨è¡Œä¸šä¸­çš„è½åœ°åº”ç”¨ï¼Œæˆ‘ä»¬å°†æ·±å…¥å‰–ææœ€å‰æ²¿çš„AIæŠ€æœ¯ï¼Œåˆ†äº«å®ç”¨çš„å¼€å‘ç»éªŒï¼Œå¹¶æ¢è®¨AIæœªæ¥çš„å‘å±•è¶‹åŠ¿  
> [AIå¼€æºæ¡†æ¶å®æˆ˜](https://blog.csdn.net/sinat_28461591/category_12946957.html)ï¼šé¢å‘ AI å·¥ç¨‹å¸ˆçš„å¤§æ¨¡å‹æ¡†æ¶å®æˆ˜æŒ‡å—ï¼Œè¦†ç›–è®­ç»ƒã€æ¨ç†ã€éƒ¨ç½²ä¸è¯„ä¼°çš„å…¨é“¾è·¯æœ€ä½³å®è·µ  
> [è®¡ç®—æœºè§†è§‰](https://blog.csdn.net/sinat_28461591/category_12921403.html)ï¼šèšç„¦è®¡ç®—æœºè§†è§‰å‰æ²¿æŠ€æœ¯ï¼Œæ¶µç›–å›¾åƒè¯†åˆ«ã€ç›®æ ‡æ£€æµ‹ã€è‡ªåŠ¨é©¾é©¶ã€åŒ»ç–—å½±åƒç­‰é¢†åŸŸçš„æœ€æ–°è¿›å±•å’Œåº”ç”¨æ¡ˆä¾‹  
> [å›½äº§å¤§æ¨¡å‹éƒ¨ç½²å®æˆ˜](https://blog.csdn.net/sinat_28461591/category_12930790.html)ï¼šæŒç»­æ›´æ–°çš„å›½äº§å¼€æºå¤§æ¨¡å‹éƒ¨ç½²å®æˆ˜æ•™ç¨‹ï¼Œè¦†ç›–ä» æ¨¡å‹é€‰å‹ â†’ ç¯å¢ƒé…ç½® â†’ æœ¬åœ°æ¨ç† â†’ APIå°è£… â†’ é«˜æ€§èƒ½éƒ¨ç½² â†’ å¤šæ¨¡å‹ç®¡ç† çš„å®Œæ•´å…¨æµç¨‹  
> [TensorFlow å…¨æ ˆå®æˆ˜ï¼šä»å»ºæ¨¡åˆ°éƒ¨ç½²](https://blog.csdn.net/sinat_28461591/category_12927920.html)ï¼šè¦†ç›–æ¨¡å‹æ„å»ºã€è®­ç»ƒä¼˜åŒ–ã€è·¨å¹³å°éƒ¨ç½²ä¸å·¥ç¨‹äº¤ä»˜ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡ä»åŸå‹åˆ°ä¸Šçº¿çš„å®Œæ•´ AI å¼€å‘æµç¨‹  
> [PyTorch å…¨æ ˆå®æˆ˜ä¸“æ ](https://blog.csdn.net/sinat_28461591/category_12928078.html)ï¼š PyTorch æ¡†æ¶çš„å…¨æ ˆå®æˆ˜åº”ç”¨ï¼Œæ¶µç›–ä»æ¨¡å‹è®­ç»ƒã€ä¼˜åŒ–ã€éƒ¨ç½²åˆ°ç»´æŠ¤çš„å®Œæ•´æµç¨‹  
> [æ·±å…¥ç†è§£ TensorRT](https://blog.csdn.net/sinat_28461591/category_12947464.html)ï¼šæ·±å…¥è§£æ TensorRT çš„æ ¸å¿ƒæœºåˆ¶ä¸éƒ¨ç½²å®è·µï¼ŒåŠ©åŠ›æ„å»ºé«˜æ€§èƒ½ AI æ¨ç†ç³»ç»Ÿ  
> [Megatron-LM å®æˆ˜ç¬”è®°](https://blog.csdn.net/sinat_28461591/category_12947574.html)ï¼šèšç„¦äº Megatron-LM æ¡†æ¶çš„å®æˆ˜åº”ç”¨ï¼Œæ¶µç›–ä»é¢„è®­ç»ƒã€å¾®è°ƒåˆ°éƒ¨ç½²çš„å…¨æµç¨‹  
> [AI Agent](https://blog.csdn.net/sinat_28461591/category_12937797.html)ï¼šç³»ç»Ÿå­¦ä¹ å¹¶äº²æ‰‹æ„å»ºä¸€ä¸ªå®Œæ•´çš„ AI Agent ç³»ç»Ÿï¼Œä»åŸºç¡€ç†è®ºã€ç®—æ³•å®æˆ˜ã€æ¡†æ¶åº”ç”¨ï¼Œåˆ°ç§æœ‰éƒ¨ç½²ã€å¤šç«¯é›†æˆ  
> [DeepSeek å®æˆ˜ä¸è§£æ](https://blog.csdn.net/sinat_28461591/category_12927989.html)ï¼šèšç„¦ DeepSeek ç³»åˆ—æ¨¡å‹åŸç†è§£æä¸å®æˆ˜åº”ç”¨ï¼Œæ¶µç›–éƒ¨ç½²ã€æ¨ç†ã€å¾®è°ƒä¸å¤šåœºæ™¯é›†æˆï¼ŒåŠ©ä½ é«˜æ•ˆä¸Šæ‰‹å›½äº§å¤§æ¨¡å‹  
> [ç«¯ä¾§å¤§æ¨¡å‹](https://blog.csdn.net/sinat_28461591/category_12940018.html)ï¼šèšç„¦å¤§æ¨¡å‹åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„éƒ¨ç½²ä¸ä¼˜åŒ–ï¼Œæ¢ç´¢ç«¯ä¾§æ™ºèƒ½çš„å®ç°è·¯å¾„  
> [è¡Œä¸šå¤§æ¨¡å‹ Â· æ•°æ®å…¨æµç¨‹æŒ‡å—](https://blog.csdn.net/sinat_28461591/category_12933004.html)ï¼šå¤§æ¨¡å‹é¢„è®­ç»ƒæ•°æ®çš„è®¾è®¡ã€é‡‡é›†ã€æ¸…æ´—ä¸åˆè§„æ²»ç†ï¼Œèšç„¦è¡Œä¸šåœºæ™¯ï¼Œä»éœ€æ±‚å®šä¹‰åˆ°æ•°æ®é—­ç¯ï¼Œå¸®åŠ©æ‚¨æ„å»ºä¸“å±çš„æ™ºèƒ½æ•°æ®åŸºåº§  
> [æœºå™¨äººç ”å‘å…¨æ ˆè¿›é˜¶æŒ‡å—ï¼šä»ROSåˆ°AIæ™ºèƒ½æ§åˆ¶](https://blog.csdn.net/sinat_28461591/category_12931488.html)ï¼šæœºå™¨äººç³»ç»Ÿæ¶æ„ã€æ„ŸçŸ¥å»ºå›¾ã€è·¯å¾„è§„åˆ’ã€æ§åˆ¶ç³»ç»Ÿã€AIæ™ºèƒ½å†³ç­–ã€ç³»ç»Ÿé›†æˆç­‰æ ¸å¿ƒèƒ½åŠ›æ¨¡å—  
> [äººå·¥æ™ºèƒ½ä¸‹çš„ç½‘ç»œå®‰å…¨](https://blog.csdn.net/sinat_28461591/category_12929944.html)ï¼šé€šè¿‡å®æˆ˜æ¡ˆä¾‹å’Œç³»ç»ŸåŒ–æ–¹æ³•ï¼Œå¸®åŠ©å¼€å‘è€…å’Œå®‰å…¨å·¥ç¨‹å¸ˆè¯†åˆ«é£é™©ã€æ„å»ºé˜²å¾¡æœºåˆ¶ï¼Œç¡®ä¿ AI ç³»ç»Ÿçš„ç¨³å®šä¸å®‰å…¨  
> [æ™ºèƒ½ DevOps å·¥å‚ï¼šAI é©±åŠ¨çš„æŒç»­äº¤ä»˜å®è·µ](https://blog.csdn.net/sinat_28461591/category_12932110.html)ï¼šæ„å»ºä»¥ AI ä¸ºæ ¸å¿ƒçš„æ™ºèƒ½ DevOps å¹³å°ï¼Œæ¶µç›–ä» CI/CD æµæ°´çº¿ã€AIOpsã€MLOps åˆ° DevSecOps çš„å…¨æµç¨‹å®è·µã€‚  
> [C++å­¦ä¹ ç¬”è®°](https://blog.csdn.net/sinat_28461591/category_12922263.html)ï¼Ÿï¼šèšç„¦äºç°ä»£ C++ ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µä¸å®è·µï¼Œæ¶µç›– STL æºç å‰–æã€å†…å­˜ç®¡ç†ã€æ¨¡æ¿å…ƒç¼–ç¨‹ç­‰å…³é”®æŠ€æœ¯  
> [AI Ã— Quant ç³»ç»ŸåŒ–è½åœ°å®æˆ˜](https://blog.csdn.net/sinat_28461591/category_12932547.html)ï¼šä»æ•°æ®ã€ç­–ç•¥åˆ°å®ç›˜ï¼Œæ‰“é€ å…¨æ ˆæ™ºèƒ½é‡åŒ–äº¤æ˜“ç³»ç»Ÿ  
> [å¤§æ¨¡å‹è¿è¥ä¸“å®¶çš„Promptä¿®ç‚¼ä¹‹è·¯](https://blog.csdn.net/sinat_28461591/category_12950767.html)ï¼šæœ¬ä¸“æ èšç„¦å¼€å‘ / æµ‹è¯•äººå‘˜çš„å®é™…è½¬å‹è·¯å¾„ï¼ŒåŸºäº OpenAIã€DeepSeekã€æŠ–éŸ³ç­‰çœŸå®èµ„æ–™ï¼Œæ‹†è§£ ä»å…¥é—¨åˆ°ä¸“ä¸šè½åœ°çš„å…³é”®ä¸»é¢˜ï¼Œæ¶µç›– Prompt ç¼–å†™èŒƒå¼ã€ç»“æ„è¾“å‡ºæ§åˆ¶ã€æ¨¡å‹è¡Œä¸ºè¯„ä¼°ã€ç³»ç»Ÿæ¥å…¥ä¸ DevOps ç®¡ç†ã€‚æ¯ä¸€ç¯‡éƒ½ä¸è®²æ¦‚å¿µç©ºè¯ï¼Œåªåšå®æˆ˜ç»éªŒæ²‰æ·€ï¼Œè®©ä½ ä¸€æ­¥æ­¥æˆä¸ºçœŸæ­£çš„æ¨¡å‹è¿è¥ä¸“å®¶ã€‚

* * *

### ğŸŒŸ å¦‚æœæœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ä¸‰è¿æ”¯æŒï¼

ğŸ‘ ç‚¹ä¸ªèµï¼Œç»™æˆ‘ä¸€äº›åé¦ˆåŠ¨åŠ›  
â­ æ”¶è—èµ·æ¥ï¼Œæ–¹ä¾¿ä¹‹åå¤ä¹ æŸ¥é˜…  
ğŸ”” å…³æ³¨æˆ‘ï¼Œåç»­è¿˜æœ‰æ›´å¤šå®æˆ˜å†…å®¹æŒç»­æ›´æ–°

* * *

> å†™ç³»ç»Ÿï¼Œä¹Ÿå†™ç§©åºï¼›å†™ä»£ç ï¼Œä¹Ÿå†™ä¸–ç•Œã€‚  
> è§‚ç†µå‡ºå“ï¼Œçš†ä¸ºå®æˆ˜æ²‰æ·€ã€‚