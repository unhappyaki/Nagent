# åˆ†å¸ƒå¼æ¨ªåˆ‡å…³æ³¨ç‚¹æ¶æ„è®¾è®¡æ–¹æ¡ˆ

## é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†Nagentä¼ä¸šçº§æ™ºèƒ½ä½“ç³»ç»Ÿåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¶æ„è®¾è®¡ã€‚é€šè¿‡åˆ†å¸ƒå¼æ¨ªåˆ‡å…³æ³¨ç‚¹è®¾è®¡ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å¤šèŠ‚ç‚¹ã€å¤šå®ä¾‹éƒ¨ç½²ç¯å¢ƒä¸‹ä¿æŒç»Ÿä¸€çš„åŸºç¡€è®¾æ–½èƒ½åŠ›å’Œè¿ç»´ç®¡ç†ä½“éªŒã€‚

## åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ¨ªåˆ‡å…³æ³¨ç‚¹çš„é‡è¦æ€§

åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ï¼Œæ¨ªåˆ‡å…³æ³¨ç‚¹ä¸ä»…é€‚ç”¨ï¼Œè€Œä¸”å˜å¾—æ›´åŠ é‡è¦ï¼

### æ ¸å¿ƒæŒ‘æˆ˜
1. **ä¸€è‡´æ€§ä¿è¯**ï¼šå¤šèŠ‚ç‚¹é—´çš„é…ç½®ã€è®¤è¯ã€ç›‘æ§ä¸€è‡´æ€§
2. **æ•…éšœéš”ç¦»**ï¼šå•ç‚¹æ•…éšœä¸èƒ½å½±å“æ•´ä½“æœåŠ¡
3. **ç½‘ç»œå»¶è¿Ÿ**ï¼šè·¨èŠ‚ç‚¹é€šä¿¡çš„å»¶è¿Ÿå¤„ç†
4. **çŠ¶æ€åŒæ­¥**ï¼šåˆ†å¸ƒå¼çŠ¶æ€çš„åŒæ­¥å’Œä¸€è‡´æ€§
5. **è¿ç»´å¤æ‚åº¦**ï¼šå¤šèŠ‚ç‚¹éƒ¨ç½²å’Œç®¡ç†çš„å¤æ‚æ€§

### è§£å†³æ–¹æ¡ˆ
é‡‡ç”¨**æ§åˆ¶å¹³é¢ + æ•°æ®å¹³é¢**çš„åˆ†å¸ƒå¼æ¶æ„æ¨¡å¼ï¼Œé€šè¿‡ç»Ÿä¸€çš„æ§åˆ¶å¹³é¢ç®¡ç†åˆ†å¸ƒå¼çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚

## åˆ†å¸ƒå¼æ¶æ„è®¾è®¡

### 1. æ··åˆæ¶æ„æ¨¡å¼

```
æ§åˆ¶å¹³é¢é›†ç¾¤ (é«˜å¯ç”¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ CP1 â”‚ â”‚ CP2 â”‚ â”‚ CP3 â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜        â”‚
â”‚    â”‚       â”‚       â”‚           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚            â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        â”‚        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node 1  â”‚ â”‚ Node 2  â”‚ â”‚ Node 3  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚è¾¹è½¦ â”‚ â”‚ â”‚ â”‚è¾¹è½¦ â”‚ â”‚ â”‚ â”‚è¾¹è½¦ â”‚ â”‚
â”‚ â”‚ä»£ç† â”‚ â”‚ â”‚ â”‚ä»£ç† â”‚ â”‚ â”‚ â”‚ä»£ç† â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ä¸šåŠ¡åŸŸâ”‚ â”‚ â”‚ â”‚ä¸šåŠ¡åŸŸâ”‚ â”‚ â”‚ â”‚ä¸šåŠ¡åŸŸâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒç»„ä»¶

#### 2.1 æ§åˆ¶å¹³é¢é›†ç¾¤

æ§åˆ¶å¹³é¢è´Ÿè´£ï¼š
- åˆ†å¸ƒå¼é…ç½®ç®¡ç†
- å…¨å±€è®¤è¯æˆæƒ
- ç›‘æ§æ•°æ®èšåˆ
- æœåŠ¡æ³¨å†Œå‘ç°
- ç­–ç•¥ä¸‹å‘

#### 2.2 è¾¹è½¦ä»£ç†

æ¯ä¸ªèŠ‚ç‚¹çš„è¾¹è½¦ä»£ç†è´Ÿè´£ï¼š
- æœ¬åœ°æ¨ªåˆ‡å…³æ³¨ç‚¹å®ç°
- ä¸æ§åˆ¶å¹³é¢é€šä¿¡
- æœ¬åœ°ç¼“å­˜å’Œæ•…éšœæ¢å¤
- ä¸šåŠ¡æµé‡ä»£ç†

## æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. åˆ†å¸ƒå¼é…ç½®ç®¡ç†

```python
class DistributedConfigService:
    """åˆ†å¸ƒå¼é…ç½®æœåŠ¡"""
    
    def __init__(self, cluster_config):
        self.etcd_client = etcd3.client(**cluster_config["etcd"])
        self.config_watchers = {}
        self.raft_consensus = RaftConsensus()
        
    async def set_config(self, key: str, value: Any):
        """è®¾ç½®é…ç½® - é€šè¿‡Raftä¸€è‡´æ€§åè®®"""
        proposal = ConfigProposal(key=key, value=value)
        
        # é€šè¿‡Raftè¾¾æˆä¸€è‡´
        consensus_result = await self.raft_consensus.propose(proposal)
        
        if consensus_result.committed:
            # é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹
            await self._broadcast_config_change(key, value)
            return True
        return False
        
    async def watch_config_changes(self, node_id: str):
        """ç›‘å¬é…ç½®å˜æ›´"""
        async for event in self.etcd_client.watch_prefix("config/"):
            await self._notify_node(node_id, event)
```

### 2. è¾¹è½¦ä»£ç†å®ç°

```python
class SidecarProxy:
    """è¾¹è½¦ä»£ç† - å®ç°æœ¬åœ°æ¨ªåˆ‡å…³æ³¨ç‚¹"""
    
    def __init__(self, node_id: str, control_plane_endpoints: List[str]):
        self.node_id = node_id
        self.control_plane_client = ControlPlaneClient(control_plane_endpoints)
        
        # æœ¬åœ°ç»„ä»¶
        self.local_gateway = LocalGateway()
        self.local_auth_cache = LocalAuthCache(ttl=300)
        self.local_monitor = LocalMonitor()
        self.local_config = LocalConfigCache()
        
        # æ•…éšœæ¢å¤
        self.fallback_handler = FallbackHandler()
        
    async def handle_request(self, request: Request) -> Response:
        """å¤„ç†è¯·æ±‚ - å®Œæ•´çš„æ¨ªåˆ‡å…³æ³¨ç‚¹å¤„ç†"""
        
        # 1. è®¤è¯æˆæƒ (æœ¬åœ°ç¼“å­˜ä¼˜å…ˆ)
        try:
            auth_result = await self._authenticate_with_fallback(request)
            if not auth_result:
                return Response(status=401)
        except ControlPlaneUnavailable:
            # æ§åˆ¶å¹³é¢ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜
            auth_result = await self.local_auth_cache.validate(request.token)
            if not auth_result:
                return Response(status=401)
        
        # 2. ç›‘æ§è¿½è¸ª
        with self.local_monitor.trace_request(request) as span:
            try:
                # 3. ä¸šåŠ¡å¤„ç†
                response = await self._route_to_business_domain(request)
                
                # 4. å¼‚æ­¥ä¸ŠæŠ¥æŒ‡æ ‡
                asyncio.create_task(
                    self._report_metrics_async(request, response)
                )
                
                return response
                
            except Exception as e:
                span.record_exception(e)
                # 5. é”™è¯¯å¤„ç†
                return await self.fallback_handler.handle_error(e, request)
```

### 3. åˆ†å¸ƒå¼ç›‘æ§

```python
class DistributedMonitoring:
    """åˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿ"""
    
    def __init__(self, config):
        self.jaeger_tracer = self._init_jaeger(config["jaeger"])
        self.prometheus_registry = self._init_prometheus(config["prometheus"])
        self.metric_aggregator = MetricAggregator()
        
    async def collect_cluster_metrics(self) -> Dict[str, Any]:
        """æ”¶é›†é›†ç¾¤æŒ‡æ ‡"""
        node_metrics = await asyncio.gather(*[
            self._collect_node_metrics(node_id) 
            for node_id in self.active_nodes
        ])
        
        return {
            "cluster_health": self._calculate_cluster_health(node_metrics),
            "total_requests": sum(m["requests"] for m in node_metrics),
            "average_latency": statistics.mean(m["latency"] for m in node_metrics),
            "error_rate": sum(m["errors"] for m in node_metrics) / sum(m["requests"] for m in node_metrics)
        }
        
    async def trace_cross_node_request(self, from_node: str, to_node: str, operation: str):
        """è·¨èŠ‚ç‚¹è¯·æ±‚è¿½è¸ª"""
        with self.jaeger_tracer.start_span(operation) as span:
            span.set_tag("node.from", from_node)
            span.set_tag("node.to", to_node)
            span.set_tag("span.kind", "cross_node")
            
            # åˆ†å¸ƒå¼è¿½è¸ªä¸Šä¸‹æ–‡ä¼ é€’
            trace_context = self.jaeger_tracer.extract_context(span)
            return trace_context
```

### 4. æ•…éšœå¤„ç†ä¸å®¹é”™

```python
class DistributedFaultHandler:
    """åˆ†å¸ƒå¼æ•…éšœå¤„ç†"""
    
    def __init__(self, config):
        self.circuit_breakers = {}
        self.retry_policies = RetryPolicyManager(config["retry"])
        self.fallback_strategies = FallbackStrategyManager(config["fallback"])
        
    async def call_with_resilience(
        self, 
        service_key: str, 
        func: Callable, 
        *args, 
        **kwargs
    ):
        """å…·å¤‡å®¹é”™èƒ½åŠ›çš„æœåŠ¡è°ƒç”¨"""
        
        # 1. æ£€æŸ¥ç†”æ–­å™¨
        circuit_breaker = self._get_circuit_breaker(service_key)
        if circuit_breaker.is_open():
            # ç†”æ–­å™¨å¼€å¯ï¼Œä½¿ç”¨é™çº§ç­–ç•¥
            return await self.fallback_strategies.execute(service_key, *args, **kwargs)
        
        # 2. é‡è¯•è°ƒç”¨
        retry_policy = self.retry_policies.get(service_key)
        
        async for attempt in retry_policy.attempts():
            try:
                result = await func(*args, **kwargs)
                
                # æˆåŠŸï¼Œé‡ç½®ç†”æ–­å™¨
                circuit_breaker.record_success()
                return result
                
            except Exception as e:
                # è®°å½•å¤±è´¥
                circuit_breaker.record_failure()
                
                if not attempt.should_retry(e):
                    # ä¸åº”é‡è¯•ï¼Œç›´æ¥å¤±è´¥æˆ–é™çº§
                    if self.fallback_strategies.has_fallback(service_key):
                        return await self.fallback_strategies.execute(service_key, *args, **kwargs)
                    raise e
                    
                # ç­‰å¾…é‡è¯•
                await attempt.wait()
                
        # é‡è¯•è€—å°½ï¼Œå°è¯•é™çº§
        if self.fallback_strategies.has_fallback(service_key):
            return await self.fallback_strategies.execute(service_key, *args, **kwargs)
            
        raise MaxRetryExceededException(f"Max retries exceeded for {service_key}")
```

## éƒ¨ç½²é…ç½®

### Docker Composeåˆ†å¸ƒå¼éƒ¨ç½²

```yaml
version: '3.8'

services:
  # æ§åˆ¶å¹³é¢é›†ç¾¤
  control-plane-1:
    image: nagent/control-plane:latest
    environment:
      - NODE_ID=cp-1
      - CLUSTER_PEERS=cp-1,cp-2,cp-3
      - ETCD_ENDPOINTS=http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379
    ports:
      - "8080:8080"
      
  control-plane-2:
    image: nagent/control-plane:latest
    environment:
      - NODE_ID=cp-2
      - CLUSTER_PEERS=cp-1,cp-2,cp-3
      - ETCD_ENDPOINTS=http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379
    ports:
      - "8081:8080"
      
  control-plane-3:
    image: nagent/control-plane:latest
    environment:
      - NODE_ID=cp-3
      - CLUSTER_PEERS=cp-1,cp-2,cp-3
      - ETCD_ENDPOINTS=http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379
    ports:
      - "8082:8080"

  # ä¸šåŠ¡èŠ‚ç‚¹é›†ç¾¤
  nagent-node-1:
    image: nagent/node:latest
    environment:
      - NODE_ID=node-1
      - NODE_TYPE=communication,execution
      - CONTROL_PLANE_ENDPOINTS=http://control-plane-1:8080,http://control-plane-2:8080,http://control-plane-3:8080
    
  nagent-node-2:
    image: nagent/node:latest
    environment:
      - NODE_ID=node-2
      - NODE_TYPE=coordination,state
      - CONTROL_PLANE_ENDPOINTS=http://control-plane-1:8080,http://control-plane-2:8080,http://control-plane-3:8080
      
  nagent-node-3:
    image: nagent/node:latest
    environment:
      - NODE_ID=node-3
      - NODE_TYPE=core,execution
      - CONTROL_PLANE_ENDPOINTS=http://control-plane-1:8080,http://control-plane-2:8080,http://control-plane-3:8080

  # åˆ†å¸ƒå¼å­˜å‚¨
  etcd-1:
    image: quay.io/coreos/etcd:v3.5.0
    environment:
      - ETCD_NAME=etcd-1
      - ETCD_INITIAL_CLUSTER=etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      
  etcd-2:
    image: quay.io/coreos/etcd:v3.5.0
    environment:
      - ETCD_NAME=etcd-2
      - ETCD_INITIAL_CLUSTER=etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      
  etcd-3:
    image: quay.io/coreos/etcd:v3.5.0
    environment:
      - ETCD_NAME=etcd-3
      - ETCD_INITIAL_CLUSTER=etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380

  # åˆ†å¸ƒå¼ç›‘æ§
  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
```

## å…³é”®æŒ‡æ ‡ç›‘æ§

### åˆ†å¸ƒå¼ç³»ç»ŸæŒ‡æ ‡

```python
class DistributedMetrics:
    """åˆ†å¸ƒå¼ç³»ç»Ÿå…³é”®æŒ‡æ ‡"""
    
    CRITICAL_METRICS = {
        # æ§åˆ¶å¹³é¢æŒ‡æ ‡
        "control_plane_availability": {
            "threshold": 0.99,
            "description": "æ§åˆ¶å¹³é¢å¯ç”¨æ€§"
        },
        "config_sync_latency": {
            "threshold": 10,  # ç§’
            "description": "é…ç½®åŒæ­¥å»¶è¿Ÿ"
        },
        
        # ç½‘ç»œæŒ‡æ ‡
        "cross_node_latency": {
            "threshold": 50,  # ms
            "description": "è·¨èŠ‚ç‚¹é€šä¿¡å»¶è¿Ÿ"
        },
        "network_partition_duration": {
            "threshold": 30,  # ç§’
            "description": "ç½‘ç»œåˆ†åŒºæŒç»­æ—¶é—´"
        },
        
        # ä¸šåŠ¡æŒ‡æ ‡
        "request_success_rate": {
            "threshold": 0.95,
            "description": "è¯·æ±‚æˆåŠŸç‡"
        },
        "circuit_breaker_open_count": {
            "threshold": 5,
            "description": "ç†”æ–­å™¨å¼€å¯æ¬¡æ•°"
        }
    }
```

## æ€»ç»“

### âœ… åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ ¸å¿ƒä¼˜åŠ¿

1. **ç»Ÿä¸€æ€§ä¿è¯**ï¼šè·¨èŠ‚ç‚¹çš„ç»Ÿä¸€åŸºç¡€è®¾æ–½ä½“éªŒ
2. **é«˜å¯ç”¨æ€§**ï¼šæ§åˆ¶å¹³é¢é›†ç¾¤ä¿è¯æœåŠ¡é«˜å¯ç”¨
3. **å¼¹æ€§æ‰©å±•**ï¼šæ–°èŠ‚ç‚¹è‡ªåŠ¨è·å¾—å®Œæ•´æ¨ªåˆ‡å…³æ³¨ç‚¹èƒ½åŠ›
4. **æ•…éšœéš”ç¦»**ï¼šå•èŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“ç³»ç»Ÿ
5. **è¿ç»´ç®€åŒ–**ï¼šç»Ÿä¸€çš„é…ç½®ã€ç›‘æ§ã€ç®¡ç†

### ğŸ¯ å®æ–½å»ºè®®

1. **æ¸è¿›å¼éƒ¨ç½²**ï¼š
   - é˜¶æ®µ1ï¼šå•èŠ‚ç‚¹éªŒè¯
   - é˜¶æ®µ2ï¼š3èŠ‚ç‚¹é›†ç¾¤éªŒè¯
   - é˜¶æ®µ3ï¼šç”Ÿäº§ç¯å¢ƒå¤§è§„æ¨¡éƒ¨ç½²

2. **ç›‘æ§é‡ç‚¹**ï¼š
   - æ§åˆ¶å¹³é¢é›†ç¾¤å¥åº·
   - èŠ‚ç‚¹é—´ç½‘ç»œè´¨é‡
   - é…ç½®åŒæ­¥çŠ¶æ€
   - åˆ†å¸ƒå¼è¿½è¸ªå®Œæ•´æ€§

3. **å®¹é”™ç­–ç•¥**ï¼š
   - æœ¬åœ°ç¼“å­˜å…œåº•
   - å¤šå‰¯æœ¬å®¹é”™
   - ç½‘ç»œåˆ†åŒºé™çº§

**ç»“è®ºï¼šåˆ†å¸ƒå¼æ¶æ„ä¸ä»…ä¸ä¼šå‰Šå¼±æ¨ªåˆ‡å…³æ³¨ç‚¹çš„ä»·å€¼ï¼Œåè€Œä½¿å…¶å˜å¾—æ›´åŠ é‡è¦å’Œå¼ºå¤§ã€‚é€šè¿‡åˆç†çš„åˆ†å¸ƒå¼è®¾è®¡ï¼Œæ¨ªåˆ‡å…³æ³¨ç‚¹å¯ä»¥åœ¨ä¿æŒç»Ÿä¸€æ€§çš„åŒæ—¶è·å¾—é«˜å¯ç”¨ã€å¯æ‰©å±•ç­‰åˆ†å¸ƒå¼ç‰¹æ€§ã€‚** 