# åŸºäºç°æœ‰æ¶æ„çš„å››å¤§åŸºç¡€è®¾æ–½å’ŒAPIç½‘å…³é›†æˆæ–¹æ¡ˆ

## æ–¹æ¡ˆæ¦‚è¿°

æœ¬æ–¹æ¡ˆåŸºäºNagentç°æœ‰çš„**åè°ƒåŸŸ**å’Œ**é€šä¿¡åŸŸ**ï¼Œé€šè¿‡å°†æ ¸å¿ƒæ³¨å†ŒåŠŸèƒ½è¿ç§»åˆ°åŸºç¡€è®¾æ–½å±‚ï¼Œå®ç°å››å¤§åè®®ç»Ÿä¸€åŸºç¡€è®¾æ–½å’ŒAPIç½‘å…³åŠŸèƒ½ã€‚é‡ç‚¹å°†Toolã€Agentã€Memoryã€Reasonerç­–ç•¥æ³¨å†ŒåŠŸèƒ½æå‡ä¸ºå¹³å°çº§åŸºç¡€è®¾æ–½èƒ½åŠ›ã€‚

## 1. åŸºç¡€è®¾æ–½æ¶æ„å±‚ç»„ä»¶è®¾è®¡

### 1.1 **ç»Ÿä¸€æ³¨å†Œä¸­å¿ƒ** - åŸºç¡€è®¾æ–½å±‚æ ¸å¿ƒ
```python
# src/infrastructure/registry/
class UnifiedModuleRegistry:
    """ç»Ÿä¸€æ¨¡å—æ³¨å†Œä¸­å¿ƒ - åŸºç¡€è®¾æ–½å±‚æ ¸å¿ƒç»„ä»¶"""
    
    def __init__(self, config_manager, auth_manager, trace_writer):
        self.config_manager = config_manager
        self.auth_manager = auth_manager
        self.trace_writer = trace_writer
        
        # å››å¤§æ ¸å¿ƒæ³¨å†Œå™¨
        self.tool_registry = ToolRegistry(self)
        self.agent_registry = AgentRegistry(self)
        self.memory_registry = MemoryRegistry(self)
        self.reasoner_registry = ReasonerRegistry(self)
        
        # åè®®æœåŠ¡æ³¨å†Œå™¨
        self.protocol_registry = ProtocolServiceRegistry(self)
    
    async def register_module(
        self,
        module_type: str,  # tool/agent/memory/reasoner/protocol
        module_id: str,
        module_config: Dict[str, Any],
        metadata: Dict[str, Any] = None
    ) -> str:
        """ç»Ÿä¸€æ¨¡å—æ³¨å†Œå…¥å£"""
        # æƒé™éªŒè¯
        if not await self.auth_manager.validate_registration_permission(module_type, module_id):
            raise PermissionError(f"No permission to register {module_type}: {module_id}")
        
        # æ ¹æ®æ¨¡å—ç±»å‹åˆ†å‘åˆ°å¯¹åº”æ³¨å†Œå™¨
        registry_map = {
            "tool": self.tool_registry,
            "agent": self.agent_registry, 
            "memory": self.memory_registry,
            "reasoner": self.reasoner_registry,
            "protocol": self.protocol_registry
        }
        
        registry = registry_map.get(module_type)
        if not registry:
            raise ValueError(f"Unsupported module type: {module_type}")
        
        # æ‰§è¡Œæ³¨å†Œ
        result = await registry.register(module_id, module_config, metadata)
        
        # è®°å½•æ³¨å†Œäº‹ä»¶
        self.trace_writer.record_event(
            trace_id=f"reg_{module_type}_{module_id}",
            event_type="MODULE_REGISTERED",
            payload={
                "module_type": module_type,
                "module_id": module_id,
                "config": module_config,
                "metadata": metadata
            }
        )
        
        return result
```

### 1.2 **Toolæ³¨å†Œå™¨** - åŸºç¡€è®¾æ–½å±‚
```python
# src/infrastructure/registry/tool_registry.py
class ToolRegistry:
    """å·¥å…·æ³¨å†Œå™¨ - åŸºç¡€è®¾æ–½å±‚ç»„ä»¶"""
    
    def __init__(self, parent_registry):
        self.parent_registry = parent_registry
        self.registered_tools = {}
        self.tool_permissions = {}
        self.tool_trace_policies = {}
    
    async def register(
        self,
        tool_id: str,
        tool_config: Dict[str, Any],
        metadata: Dict[str, Any] = None
    ) -> str:
        """æ³¨å†Œå·¥å…·"""
        # åŠ¨æ€æƒé™ç»‘å®š
        permissions = tool_config.get("permissions", [])
        self.tool_permissions[tool_id] = permissions
        
        # Traceç­–ç•¥æ³¨å…¥
        trace_policy = tool_config.get("trace_policy", {
            "enabled": True,
            "level": "INFO",
            "include_input": True,
            "include_output": True
        })
        self.tool_trace_policies[tool_id] = trace_policy
        
        # å·¥å…·å®ä¾‹åŒ–é…ç½®
        tool_instance_config = {
            "tool_id": tool_id,
            "tool_class": tool_config.get("tool_class"),
            "init_params": tool_config.get("init_params", {}),
            "permissions": permissions,
            "trace_policy": trace_policy,
            "metadata": metadata or {}
        }
        
        self.registered_tools[tool_id] = tool_instance_config
        
        # é€šçŸ¥é…ç½®ç®¡ç†å™¨æ›´æ–°
        await self.parent_registry.config_manager.update_tool_config(tool_id, tool_instance_config)
        
        return tool_id
    
    async def get_tool_config(self, tool_id: str) -> Dict[str, Any]:
        """è·å–å·¥å…·é…ç½®"""
        return self.registered_tools.get(tool_id)
    
    async def list_tools(self, filter_by: Dict[str, Any] = None) -> List[str]:
        """åˆ—å‡ºå·¥å…·"""
        if not filter_by:
            return list(self.registered_tools.keys())
        
        # æ ¹æ®è¿‡æ»¤æ¡ä»¶è¿”å›å·¥å…·åˆ—è¡¨
        filtered_tools = []
        for tool_id, config in self.registered_tools.items():
            if self._matches_filter(config, filter_by):
                filtered_tools.append(tool_id)
        
        return filtered_tools
```

### 1.3 **Agentæ³¨å†Œå™¨** - åŸºç¡€è®¾æ–½å±‚
```python
# src/infrastructure/registry/agent_registry.py
class AgentRegistry:
    """æ™ºèƒ½ä½“æ³¨å†Œå™¨ - åŸºç¡€è®¾æ–½å±‚ç»„ä»¶"""
    
    def __init__(self, parent_registry):
        self.parent_registry = parent_registry
        self.registered_agents = {}
        self.agent_metadata = {}
        self.agent_permissions = {}
        self.trace_writers = {}
    
    async def register(
        self,
        agent_id: str,
        agent_config: Dict[str, Any],
        metadata: Dict[str, Any] = None
    ) -> str:
        """æ³¨å†Œæ™ºèƒ½ä½“"""
        # Metadataæ³¨å…¥
        enhanced_metadata = {
            "agent_id": agent_id,
            "agent_type": agent_config.get("agent_type"),
            "model": agent_config.get("model"),
            "capabilities": agent_config.get("capabilities", []),
            "created_at": datetime.utcnow().isoformat(),
            **(metadata or {})
        }
        self.agent_metadata[agent_id] = enhanced_metadata
        
        # æƒé™ç»‘å®š
        permissions = agent_config.get("permissions", [])
        self.agent_permissions[agent_id] = permissions
        
        # TraceWriteræ³¨å…¥å™¨
        trace_writer = self.parent_registry.trace_writer.create_agent_tracer(agent_id)
        self.trace_writers[agent_id] = trace_writer
        
        # Agentå®ä¾‹åŒ–é…ç½®
        agent_instance_config = {
            "agent_id": agent_id,
            "agent_class": agent_config.get("agent_class"),
            "init_params": agent_config.get("init_params", {}),
            "metadata": enhanced_metadata,
            "permissions": permissions,
            "trace_writer": trace_writer,
            "config": agent_config
        }
        
        self.registered_agents[agent_id] = agent_instance_config
        
        # é€šçŸ¥é…ç½®ç®¡ç†å™¨æ›´æ–°
        await self.parent_registry.config_manager.update_agent_config(agent_id, agent_instance_config)
        
        return agent_id
    
    async def get_agent_tracer(self, agent_id: str):
        """è·å–Agentä¸“ç”¨è¿½è¸ªå™¨"""
        return self.trace_writers.get(agent_id)
    
    async def get_agent_permissions(self, agent_id: str) -> List[str]:
        """è·å–Agentæƒé™"""
        return self.agent_permissions.get(agent_id, [])
```

### 1.4 **Memoryæ³¨å†Œå™¨** - åŸºç¡€è®¾æ–½å±‚
```python
# src/infrastructure/registry/memory_registry.py
class MemoryRegistry:
    """è®°å¿†æ³¨å†Œå™¨ - åŸºç¡€è®¾æ–½å±‚ç»„ä»¶"""
    
    def __init__(self, parent_registry):
        self.parent_registry = parent_registry
        self.registered_memories = {}
        self.memory_modes = {}
    
    async def register(
        self,
        memory_id: str,
        memory_config: Dict[str, Any],
        metadata: Dict[str, Any] = None
    ) -> str:
        """æ³¨å†Œè®°å¿†ç±»å‹"""
        # é…ç½®çŸ­æ—¶/é•¿æ—¶/å†»ç»“/åŠ å¯†æ¨¡å¼
        memory_mode = memory_config.get("mode", "short_term")
        mode_config = {
            "mode": memory_mode,
            "ttl": memory_config.get("ttl", 3600),  # é»˜è®¤1å°æ—¶
            "encryption": memory_config.get("encryption", False),
            "frozen": memory_config.get("frozen", False),
            "persistence": memory_config.get("persistence", memory_mode in ["long_term", "frozen"])
        }
        self.memory_modes[memory_id] = mode_config
        
        # Memoryå®ä¾‹åŒ–é…ç½®
        memory_instance_config = {
            "memory_id": memory_id,
            "memory_class": memory_config.get("memory_class"),
            "init_params": memory_config.get("init_params", {}),
            "mode_config": mode_config,
            "metadata": metadata or {}
        }
        
        self.registered_memories[memory_id] = memory_instance_config
        
        # é€šçŸ¥é…ç½®ç®¡ç†å™¨æ›´æ–°
        await self.parent_registry.config_manager.update_memory_config(memory_id, memory_instance_config)
        
        return memory_id
    
    async def get_memory_mode(self, memory_id: str) -> Dict[str, Any]:
        """è·å–è®°å¿†æ¨¡å¼é…ç½®"""
        return self.memory_modes.get(memory_id)
```

### 1.5 **Reasonerç­–ç•¥æ³¨å†Œå™¨** - åŸºç¡€è®¾æ–½å±‚
```python
# src/infrastructure/registry/reasoner_registry.py
class ReasonerRegistry:
    """æ¨ç†å™¨ç­–ç•¥æ³¨å†Œå™¨ - åŸºç¡€è®¾æ–½å±‚ç»„ä»¶"""
    
    def __init__(self, parent_registry):
        self.parent_registry = parent_registry
        self.registered_reasoners = {}
        self.reasoner_strategies = {}
    
    async def register(
        self,
        reasoner_id: str,
        reasoner_config: Dict[str, Any],
        metadata: Dict[str, Any] = None
    ) -> str:
        """æ³¨å†Œæ¨ç†å™¨ç­–ç•¥"""
        # æ”¯æŒprompt-template / RL-policy / flow-basedæ¨ç†å™¨åˆ‡æ¢
        strategy_type = reasoner_config.get("strategy_type", "prompt_template")
        
        strategy_config = {
            "strategy_type": strategy_type,
            "template": reasoner_config.get("template") if strategy_type == "prompt_template" else None,
            "policy": reasoner_config.get("policy") if strategy_type == "rl_policy" else None,
            "flow": reasoner_config.get("flow") if strategy_type == "flow_based" else None,
            "switchable": reasoner_config.get("switchable", True)
        }
        self.reasoner_strategies[reasoner_id] = strategy_config
        
        # Reasonerå®ä¾‹åŒ–é…ç½®
        reasoner_instance_config = {
            "reasoner_id": reasoner_id,
            "reasoner_class": reasoner_config.get("reasoner_class"),
            "init_params": reasoner_config.get("init_params", {}),
            "strategy_config": strategy_config,
            "metadata": metadata or {}
        }
        
        self.registered_reasoners[reasoner_id] = reasoner_instance_config
        
        # é€šçŸ¥é…ç½®ç®¡ç†å™¨æ›´æ–°
        await self.parent_registry.config_manager.update_reasoner_config(reasoner_id, reasoner_instance_config)
        
        return reasoner_id
    
    async def switch_strategy(
        self,
        reasoner_id: str,
        new_strategy_type: str,
        new_strategy_config: Dict[str, Any]
    ) -> bool:
        """åˆ‡æ¢æ¨ç†å™¨ç­–ç•¥"""
        if reasoner_id not in self.registered_reasoners:
            return False
        
        reasoner_config = self.registered_reasoners[reasoner_id]
        if not reasoner_config["strategy_config"]["switchable"]:
            return False
        
        # æ›´æ–°ç­–ç•¥é…ç½®
        reasoner_config["strategy_config"]["strategy_type"] = new_strategy_type
        reasoner_config["strategy_config"].update(new_strategy_config)
        
        # é€šçŸ¥é…ç½®ç®¡ç†å™¨æ›´æ–°
        await self.parent_registry.config_manager.update_reasoner_config(reasoner_id, reasoner_config)
        
        return True
```

## 2. åŸºç¡€è®¾æ–½å±‚å®Œæ•´æ¶æ„

### 2.1 æ¨èçš„åŸºç¡€è®¾æ–½å±‚ç›®å½•ç»“æ„
```
src/infrastructure/
â”œâ”€â”€ registry/                        # ğŸ”¥ æ ¸å¿ƒæ³¨å†Œä¸­å¿ƒ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ unified_registry.py          # ç»Ÿä¸€æ³¨å†Œä¸­å¿ƒ â­â­â­â­â­
â”‚   â”œâ”€â”€ tool_registry.py             # Toolæ³¨å†Œå™¨ â­â­â­â­â­
â”‚   â”œâ”€â”€ agent_registry.py            # Agentæ³¨å†Œå™¨ â­â­â­â­â­
â”‚   â”œâ”€â”€ memory_registry.py           # Memoryæ³¨å†Œå™¨ â­â­â­â­â­
â”‚   â”œâ”€â”€ reasoner_registry.py         # Reasonerç­–ç•¥æ³¨å†Œå™¨ â­â­â­â­â­
â”‚   â””â”€â”€ protocol_registry.py         # åè®®æœåŠ¡æ³¨å†Œå™¨ â­â­â­â­
â”œâ”€â”€ gateway/                         # ğŸŒ ç»Ÿä¸€ç½‘å…³
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ unified_gateway.py           # ç»Ÿä¸€APIç½‘å…³ â­â­â­â­â­
â”‚   â”œâ”€â”€ protocol_router.py           # åè®®è·¯ç”±å™¨ â­â­â­â­â­
â”‚   â”œâ”€â”€ rate_limiter.py              # é™æµå™¨ â­â­â­â­
â”‚   â””â”€â”€ load_balancer.py             # è´Ÿè½½å‡è¡¡å™¨ â­â­â­â­
â”œâ”€â”€ auth/                            # ğŸ” ç»Ÿä¸€è®¤è¯
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ unified_auth.py              # ç»Ÿä¸€è®¤è¯ â­â­â­â­â­
â”‚   â”œâ”€â”€ token_manager.py             # ä»¤ç‰Œç®¡ç† â­â­â­â­â­
â”‚   â”œâ”€â”€ permission_manager.py        # æƒé™ç®¡ç† â­â­â­â­â­
â”‚   â””â”€â”€ security_policy.py           # å®‰å…¨ç­–ç•¥ â­â­â­â­
â”œâ”€â”€ config/                          # âš™ï¸ ç»Ÿä¸€é…ç½®
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ unified_config.py            # ç»Ÿä¸€é…ç½® â­â­â­â­
â”‚   â”œâ”€â”€ hot_reload.py                # çƒ­é‡è½½ â­â­â­
â”‚   â”œâ”€â”€ module_config_manager.py     # æ¨¡å—é…ç½®ç®¡ç† â­â­â­â­â­
â”‚   â””â”€â”€ environment_manager.py       # ç¯å¢ƒç®¡ç† â­â­â­
â””â”€â”€ discovery/                       # ğŸ” æœåŠ¡å‘ç°
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ service_discovery.py         # æœåŠ¡å‘ç° â­â­â­â­
    â”œâ”€â”€ health_checker.py            # å¥åº·æ£€æŸ¥ â­â­â­â­
    â””â”€â”€ registry_client.py           # æ³¨å†Œå®¢æˆ·ç«¯ â­â­â­
```

### 2.2 ä¸ç°æœ‰ç›‘æ§ç³»ç»Ÿçš„é›†æˆ
```python
# å¤ç”¨ç°æœ‰çš„ç›‘æ§ç³»ç»Ÿ
from src.monitoring.logging import LogManager
from src.monitoring.tracing import TraceWriter
from src.monitoring.metrics import MetricsCollector

class InfrastructureMonitoringIntegration:
    """åŸºç¡€è®¾æ–½ç›‘æ§é›†æˆ"""
    
    def __init__(self):
        # å¤ç”¨ç°æœ‰ç›‘æ§ç»„ä»¶
        self.log_manager = LogManager()
        self.trace_writer = TraceWriter()
        self.metrics_collector = MetricsCollector()
    
    def integrate_with_registry(self, registry: UnifiedModuleRegistry):
        """ä¸æ³¨å†Œä¸­å¿ƒé›†æˆ"""
        registry.trace_writer = self.trace_writer
        registry.metrics_collector = self.metrics_collector
```

## 3. å®æ–½ä¼˜å…ˆçº§

### ğŸ”¥ **P0 - ç«‹å³å®ç°ï¼ˆç¬¬1å‘¨ï¼‰**
1. **ç»Ÿä¸€æ³¨å†Œä¸­å¿ƒ** (`src/infrastructure/registry/unified_registry.py`)
2. **Toolæ³¨å†Œå™¨** (`src/infrastructure/registry/tool_registry.py`)
3. **Agentæ³¨å†Œå™¨** (`src/infrastructure/registry/agent_registry.py`)

### âš¡ **P1 - çŸ­æœŸå®ç°ï¼ˆç¬¬2å‘¨ï¼‰**
1. **Memoryæ³¨å†Œå™¨** (`src/infrastructure/registry/memory_registry.py`)
2. **Reasonerç­–ç•¥æ³¨å†Œå™¨** (`src/infrastructure/registry/reasoner_registry.py`)
3. **ç»Ÿä¸€ç½‘å…³** (`src/infrastructure/gateway/unified_gateway.py`)

### ğŸ¯ **P2 - ä¸­æœŸå®ç°ï¼ˆç¬¬3-4å‘¨ï¼‰**
1. **ç»Ÿä¸€è®¤è¯** (`src/infrastructure/auth/unified_auth.py`)
2. **ç»Ÿä¸€é…ç½®** (`src/infrastructure/config/unified_config.py`)
3. **æœåŠ¡å‘ç°** (`src/infrastructure/discovery/service_discovery.py`)

### ğŸš€ **P3 - é•¿æœŸå®Œå–„ï¼ˆç¬¬5å‘¨ï¼‰**
1. **åè®®è·¯ç”±å™¨** (`src/infrastructure/gateway/protocol_router.py`)
2. **æƒé™ç®¡ç†** (`src/infrastructure/auth/permission_manager.py`)
3. **æ¨¡å—é…ç½®ç®¡ç†** (`src/infrastructure/config/module_config_manager.py`)

## 4. æ¶æ„ä¼˜åŠ¿

### 4.1 **å¹³å°åŒ–èƒ½åŠ›**
- **ç»Ÿä¸€æ³¨å†Œå…¥å£** - æ‰€æœ‰æ¨¡å—é€šè¿‡ç»Ÿä¸€æ¥å£æ³¨å†Œ
- **åŠ¨æ€é…ç½®ç®¡ç†** - æ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ–°
- **æƒé™ç»Ÿä¸€ç®¡ç†** - åŸºç¡€è®¾æ–½å±‚ç»Ÿä¸€æƒé™æ§åˆ¶
- **è¿½è¸ªç­–ç•¥æ³¨å…¥** - è‡ªåŠ¨ä¸ºæ‰€æœ‰æ¨¡å—æ³¨å…¥è¿½è¸ªèƒ½åŠ›

### 4.2 **ç°æœ‰æŠ•èµ„å¤ç”¨**
- **ç›‘æ§ç³»ç»Ÿå¤ç”¨** - å®Œå…¨å¤ç”¨ç°æœ‰ç›‘æ§ç»„ä»¶
- **é…ç½®ç³»ç»Ÿæ‰©å±•** - åŸºäºç°æœ‰é…ç½®ç³»ç»Ÿæ‰©å±•
- **æƒé™ç³»ç»Ÿå¢å¼º** - åŸºäºç°æœ‰æƒé™æ¡†æ¶å¢å¼º

### 4.3 **æ¶æ„æ¸…æ™°åº¦**
- **åŸºç¡€è®¾æ–½å±‚èŒè´£æ˜ç¡®** - åªè´Ÿè´£æ³¨å†Œã€ç½‘å…³ã€è®¤è¯ã€é…ç½®ã€å‘ç°
- **ä¸šåŠ¡åŸŸä¿æŒç‹¬ç«‹** - ä¸šåŠ¡é€»è¾‘ä»åœ¨å„è‡ªåŸŸå†…
- **æ¨ªåˆ‡å…³æ³¨ç‚¹ç»Ÿä¸€** - æ‰€æœ‰æ¨ªåˆ‡å…³æ³¨ç‚¹åœ¨åŸºç¡€è®¾æ–½å±‚ç»Ÿä¸€å¤„ç†

è¿™æ ·çš„è®¾è®¡æ—¢æ»¡è¶³äº†å°†æ ¸å¿ƒæ³¨å†ŒåŠŸèƒ½æå‡ä¸ºåŸºç¡€è®¾æ–½èƒ½åŠ›çš„è¦æ±‚ï¼Œåˆä¿æŒäº†ä¸ç°æœ‰æ¶æ„çš„å…¼å®¹æ€§ï¼ŒåŒæ—¶å……åˆ†å¤ç”¨äº†ç°æœ‰çš„ç›‘æ§ç³»ç»ŸæŠ•èµ„ã€‚ 